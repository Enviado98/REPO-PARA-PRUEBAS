<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitor Citas â€” Consulado EspaÃ±a La Habana</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Syne:wght@400;700;800&display=swap');

  :root {
    --bg:        #0a0a0f;
    --panel:     #0f0f1a;
    --border:    #1e1e35;
    --green:     #00ff9d;
    --red:       #ff3c5a;
    --yellow:    #ffd24d;
    --blue:      #4da6ff;
    --dim:       #4a4a6a;
    --text:      #c8c8e8;
    --mono:      'Share Tech Mono', monospace;
    --sans:      'Syne', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    padding: 20px;
    overflow-x: hidden;
  }

  /* GRID SCANLINES overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,157,0.015) 2px, rgba(0,255,157,0.015) 4px);
    pointer-events: none;
    z-index: 0;
  }

  .wrapper { max-width: 860px; margin: 0 auto; position: relative; z-index: 1; }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    border-bottom: 1px solid var(--border);
    padding-bottom: 18px;
    margin-bottom: 24px;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    flex-wrap: wrap;
  }
  .title-block {}
  .title-block h1 {
    font-size: 1.3rem;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: #fff;
  }
  .title-block p {
    font-size: 0.75rem;
    color: var(--dim);
    font-family: var(--mono);
    margin-top: 4px;
  }

  .status-pill {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 6px 14px;
    font-family: var(--mono);
    font-size: 0.7rem;
    white-space: nowrap;
  }
  .pulse {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--yellow);
    animation: blink 1.2s infinite;
    flex-shrink: 0;
  }
  .pulse.done { background: var(--green); animation: none; }
  .pulse.err  { background: var(--red);   animation: none; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }

  /* â”€â”€ VEREDICTO â”€â”€ */
  .veredicto {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 22px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 18px;
    min-height: 90px;
  }
  .veredicto-icon {
    font-size: 2.8rem;
    flex-shrink: 0;
    line-height: 1;
  }
  .veredicto-text {}
  .veredicto-text .label {
    font-size: 0.65rem;
    font-family: var(--mono);
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  .veredicto-text .conclusion {
    font-size: 1.05rem;
    font-weight: 700;
    color: #fff;
    margin-top: 4px;
    line-height: 1.35;
  }
  .veredicto-text .sub {
    font-size: 0.75rem;
    color: var(--dim);
    font-family: var(--mono);
    margin-top: 5px;
  }
  .veredicto.ok     { border-color: var(--green); }
  .veredicto.maybe  { border-color: var(--yellow); }
  .veredicto.no     { border-color: var(--red); }
  .veredicto.loading { border-color: var(--border); }

  /* â”€â”€ FUENTES GRID â”€â”€ */
  .sources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .source-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    transition: border-color .2s;
  }
  .source-card.ok     { border-color: rgba(0,255,157,.35); }
  .source-card.warn   { border-color: rgba(255,210,77,.35); }
  .source-card.err    { border-color: rgba(255,60,90,.35); }
  .source-card.loading{ border-color: var(--border); }

  .source-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .source-name {
    font-size: 0.7rem;
    font-family: var(--mono);
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }
  .badge {
    font-size: 0.6rem;
    font-family: var(--mono);
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: bold;
  }
  .badge.ok   { background: rgba(0,255,157,.15); color: var(--green); }
  .badge.warn { background: rgba(255,210,77,.15); color: var(--yellow); }
  .badge.err  { background: rgba(255,60,90,.15);  color: var(--red); }
  .badge.loading { background: rgba(255,255,255,.05); color: var(--dim); }

  .source-result {
    font-size: 0.8rem;
    color: var(--text);
    line-height: 1.45;
  }
  .source-result.empty { color: var(--dim); font-family: var(--mono); font-size: 0.72rem; }

  /* â”€â”€ LOG â”€â”€ */
  .log-wrap {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }
  .log-header {
    padding: 8px 14px;
    border-bottom: 1px solid var(--border);
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--dim);
    display: flex;
    justify-content: space-between;
  }
  .log-body {
    padding: 12px 14px;
    max-height: 220px;
    overflow-y: auto;
    font-family: var(--mono);
    font-size: 0.7rem;
    line-height: 1.7;
  }
  .log-body::-webkit-scrollbar { width: 3px; }
  .log-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .log-line { display: flex; gap: 10px; }
  .log-time { color: var(--dim); flex-shrink: 0; }
  .log-msg.g { color: var(--green); }
  .log-msg.y { color: var(--yellow); }
  .log-msg.r { color: var(--red); }
  .log-msg.b { color: var(--blue); }
  .log-msg.d { color: var(--dim); }

  /* â”€â”€ BOTÃ“N â”€â”€ */
  .run-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: transparent;
    border: 1px solid var(--green);
    color: var(--green);
    font-family: var(--mono);
    font-size: 0.78rem;
    padding: 8px 18px;
    border-radius: 6px;
    cursor: pointer;
    transition: all .2s;
    margin-top: 16px;
  }
  .run-btn:hover { background: rgba(0,255,157,.1); }
  .run-btn:disabled { opacity: .4; cursor: not-allowed; }

  /* â”€â”€ INFO BOX â”€â”€ */
  .info-box {
    margin-top: 16px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-left: 3px solid var(--blue);
    border-radius: 0 8px 8px 0;
    padding: 12px 16px;
    font-size: 0.78rem;
    line-height: 1.6;
    color: var(--text);
  }
  .info-box strong { color: #fff; }
  .info-box a { color: var(--blue); text-decoration: none; }
  .info-box a:hover { text-decoration: underline; }

  /* â”€â”€ KEYWORD HITS â”€â”€ */
  .kw-hit {
    display: inline-block;
    background: rgba(0,255,157,.12);
    color: var(--green);
    border-radius: 4px;
    padding: 0 5px;
    font-family: var(--mono);
    font-size: 0.72rem;
  }
  .kw-hit.neg {
    background: rgba(255,60,90,.12);
    color: var(--red);
  }

  @media (max-width: 500px) {
    .sources-grid { grid-template-columns: 1fr; }
    header { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="wrapper">

  <header>
    <div class="title-block">
      <h1>ğŸ” Monitor de Citas â€” Consulado EspaÃ±a / La Habana</h1>
      <p>TEST DE FUENTES PÃšBLICAS Â· OpciÃ³n B Â· v1.0</p>
    </div>
    <div class="status-pill" id="globalPill">
      <div class="pulse" id="globalDot"></div>
      <span id="globalStatus">Listo para escanear</span>
    </div>
  </header>

  <!-- VEREDICTO FINAL -->
  <div class="veredicto loading" id="veredicto">
    <div class="veredicto-icon" id="verdIcon">ğŸ”</div>
    <div class="veredicto-text">
      <div class="label">ConclusiÃ³n del anÃ¡lisis</div>
      <div class="conclusion" id="verdText">Pulsa "Ejecutar AnÃ¡lisis" para comenzar</div>
      <div class="sub" id="verdSub">El sistema consultarÃ¡ 4 fuentes pÃºblicas independientes</div>
    </div>
  </div>

  <!-- FUENTES -->
  <div class="sources-grid" id="sourcesGrid">

    <div class="source-card loading" id="card-oficial">
      <div class="source-header">
        <span class="source-name">Web Oficial Consulado</span>
        <span class="badge loading" id="badge-oficial">PENDIENTE</span>
      </div>
      <div class="source-result empty" id="result-oficial">Esperando ejecuciÃ³n...</div>
    </div>

    <div class="source-card loading" id="card-twitter">
      <div class="source-header">
        <span class="source-name">X / Twitter @ConsEspLaHabana</span>
        <span class="badge loading" id="badge-twitter">PENDIENTE</span>
      </div>
      <div class="source-result empty" id="result-twitter">Esperando ejecuciÃ³n...</div>
    </div>

    <div class="source-card loading" id="card-dimecuba">
      <div class="source-header">
        <span class="source-name">DimeCuba â€” Noticias consulado</span>
        <span class="badge loading" id="badge-dimecuba">PENDIENTE</span>
      </div>
      <div class="source-result empty" id="result-dimecuba">Esperando ejecuciÃ³n...</div>
    </div>

    <div class="source-card loading" id="card-directorio">
      <div class="source-header">
        <span class="source-name">DirectorioCubano â€” Foros</span>
        <span class="badge loading" id="badge-directorio">PENDIENTE</span>
      </div>
      <div class="source-result empty" id="result-directorio">Esperando ejecuciÃ³n...</div>
    </div>

  </div>

  <!-- LOG -->
  <div class="log-wrap">
    <div class="log-header">
      <span>REGISTRO DE EJECUCIÃ“N</span>
      <span id="logCount">0 entradas</span>
    </div>
    <div class="log-body" id="logBody">
      <div class="log-line">
        <span class="log-time">--:--:--</span>
        <span class="log-msg d">Sistema iniciado. Pulsa ejecutar para comenzar el anÃ¡lisis.</span>
      </div>
    </div>
  </div>

  <button class="run-btn" id="runBtn" onclick="runAnalysis()">
    â–¶ Ejecutar AnÃ¡lisis Ahora
  </button>

  <div class="info-box">
    <strong>Â¿QuÃ© hace este test?</strong><br>
    Consulta 4 fuentes pÃºblicas via proxy CORS y busca palabras clave relacionadas con disponibilidad de citas ("citas disponibles", "nueva fecha", "abierto", etc.).
    La plataforma de citas oficial (<code>sede.maec.gob.es</code>) requiere login personal, por lo que <strong>no se puede verificar disponibilidad directamente sin credenciales</strong>.
    Este anÃ¡lisis detecta seÃ±ales indirectas: anuncios del consulado, comentarios de la comunidad y noticias recientes.<br><br>
    <strong>Para pedir cita:</strong> regÃ­strate enviando correo a
    <a href="mailto:cog.lahabana.cleg@maec.es">cog.lahabana.cleg@maec.es</a>
    con asunto <strong>CITA LEGA</strong> adjuntando foto con tu carnÃ©.
    RecibirÃ¡s usuario y contraseÃ±a para acceder al sistema.
  </div>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROXIES = [
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
];

// Palabras clave positivas (hay citas)
const KW_YES = [
  "citas disponibles","cita disponible","nueva fecha","fechas disponibles",
  "abierto.*citas","citas abiertas","se abren citas","hay citas",
  "pueden sacar cita","nuevas citas","slots disponibles",
  "ya hay cita","vuelven las citas"
];

// Palabras clave negativas (no hay citas)
const KW_NO = [
  "no hay citas","sin citas","no estÃ¡n disponibles","no existen citas",
  "no hay horas disponibles","pÃ¡gina bloqueada","citas agotadas",
  "no.*cita disponible","lista de espera","demora","saturado",
  "no se aceptan","paraliz","no hay fechas"
];

const SOURCES = [
  {
    id: "oficial",
    name: "Web oficial exteriores.gob.es",
    url: "https://www.exteriores.gob.es/Consulados/lahabana/es/ServiciosConsulares/Paginas/index.aspx?scca=Legalizaci%C3%B3n+o+Apostilla.+Compulsa+y+Registro&scco=Cuba&scd=166&scs=Legalizaci%C3%B3n+y+apostilla+de+la+Haya",
  },
  {
    id: "twitter",
    name: "Nitter (X/Twitter) @ConsEspLaHabana",
    url: "https://nitter.poast.org/ConsEspLaHabana",
    fallback: "https://nitter.privacydev.net/ConsEspLaHabana"
  },
  {
    id: "dimecuba",
    name: "DimeCuba",
    url: "https://www.dimecuba.com/revista/nacionalidad-espanola/consulado-espana-en-cuba/",
  },
  {
    id: "directorio",
    name: "DirectorioCubano",
    url: "https://www.directoriocubano.info/panorama/nuevo-sistema-de-citas-para-legalizaciones-en-el-consulado-de-espana-en-la-habana/",
  }
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let logLines = 0;
function log(msg, type = 'd') {
  const body = document.getElementById('logBody');
  const now = new Date().toLocaleTimeString('es-ES');
  const line = document.createElement('div');
  line.className = 'log-line';
  line.innerHTML = `<span class="log-time">${now}</span><span class="log-msg ${type}">${msg}</span>`;
  body.appendChild(line);
  body.scrollTop = body.scrollHeight;
  logLines++;
  document.getElementById('logCount').textContent = `${logLines} entradas`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FETCH VIA PROXY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchViaProxy(url, fallback = null) {
  const urls = [url, ...(fallback ? [fallback] : [])];
  for (const target of urls) {
    for (const makeProxy of PROXIES) {
      const proxy = makeProxy(target);
      try {
        log(`Intentando proxy: ${proxy.slice(0,60)}...`, 'd');
        const res = await Promise.race([
          fetch(proxy),
          new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 12000))
        ]);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        if (text.length < 200) throw new Error('Respuesta demasiado corta');
        log(`âœ“ Obtenido (${(text.length/1024).toFixed(1)} KB)`, 'g');
        return text;
      } catch(e) {
        log(`âœ— FallÃ³: ${e.message}`, 'r');
      }
    }
  }
  return null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANÃLISIS DE TEXTO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function analyzeText(html) {
  // Limpiar HTML a texto plano
  const tmp = document.createElement('div');
  tmp.innerHTML = html.replace(/<script[\s\S]*?<\/script>/gi,'').replace(/<style[\s\S]*?<\/style>/gi,'');
  const text = (tmp.innerText || tmp.textContent || '').toLowerCase();

  const hitsYes = KW_YES.filter(kw => new RegExp(kw,'i').test(text));
  const hitsNo  = KW_NO.filter(kw  => new RegExp(kw,'i').test(text));

  // Buscar fechas recientes mencionadas (Ãºltimos 7 dÃ­as)
  const today  = new Date();
  const dayNames = ['domingo','lunes','martes','miÃ©rcoles','jueves','viernes','sÃ¡bado'];
  const monthNames = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];

  // Extraer fragmentos de contexto para keywords
  const snippets = [];
  [...hitsYes, ...hitsNo].slice(0,3).forEach(kw => {
    const idx = text.search(new RegExp(kw, 'i'));
    if (idx !== -1) {
      const raw = text.slice(Math.max(0, idx-60), idx+100).replace(/\s+/g,' ').trim();
      snippets.push(`"â€¦${raw}â€¦"`);
    }
  });

  return { hitsYes, hitsNo, snippets, textLength: text.length };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ACTUALIZAR TARJETA DE FUENTE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateCard(id, status, badgeText, resultHTML) {
  const card  = document.getElementById(`card-${id}`);
  const badge = document.getElementById(`badge-${id}`);
  const res   = document.getElementById(`result-${id}`);

  card.className  = `source-card ${status}`;
  badge.className = `badge ${status}`;
  badge.textContent = badgeText;
  res.className   = `source-result`;
  res.innerHTML   = resultHTML;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAnalysis() {
  const btn = document.getElementById('runBtn');
  btn.disabled = true;

  // Reset UI
  SOURCES.forEach(s => updateCard(s.id, 'loading', 'CONSULTANDO...', 'Descargando contenido...'));
  setVeredicto('loading', 'ğŸ”„', 'Analizando fuentes...', 'Por favor espera');
  setGlobalStatus('Analizando...', false);

  log('â•â•â• INICIO DE ANÃLISIS â•â•â•', 'b');

  const results = [];

  for (const source of SOURCES) {
    log(`â–º Consultando: ${source.name}`, 'b');
    const html = await fetchViaProxy(source.url, source.fallback || null);

    if (!html) {
      log(`  âœ— Fuente inaccesible`, 'r');
      updateCard(source.id, 'err', 'ERROR', 'âš ï¸ No se pudo obtener el contenido (proxy bloqueado o fuente caÃ­da).');
      results.push({ id: source.id, ok: false, hitsYes: [], hitsNo: [], snippets: [] });
      continue;
    }

    const analysis = analyzeText(html);
    log(`  Texto obtenido: ${analysis.textLength} chars`, 'd');
    log(`  Keywords positivas: ${analysis.hitsYes.length > 0 ? analysis.hitsYes.join(', ') : 'ninguna'}`, analysis.hitsYes.length > 0 ? 'g' : 'd');
    log(`  Keywords negativas: ${analysis.hitsNo.length > 0 ? analysis.hitsNo.join(', ') : 'ninguna'}`, analysis.hitsNo.length > 0 ? 'r' : 'd');

    const hasPositive = analysis.hitsYes.length > 0;
    const hasNegative = analysis.hitsNo.length > 0;
    const cardStatus  = hasPositive ? 'ok' : hasNegative ? 'warn' : 'loading';
    const badgeText   = hasPositive ? 'âœ“ SEÃ‘ALES POSITIVAS' : hasNegative ? 'âœ— SEÃ‘ALES NEGATIVAS' : 'SIN SEÃ‘ALES';

    let resultHTML = '';
    if (analysis.hitsYes.length) {
      resultHTML += `<div style="margin-bottom:6px">ğŸŸ¢ Encontrado: ${analysis.hitsYes.map(k => `<span class="kw-hit">${k}</span>`).join(' ')}</div>`;
    }
    if (analysis.hitsNo.length) {
      resultHTML += `<div style="margin-bottom:6px">ğŸ”´ Encontrado: ${analysis.hitsNo.map(k => `<span class="kw-hit neg">${k}</span>`).join(' ')}</div>`;
    }
    if (analysis.snippets.length) {
      resultHTML += `<div style="font-size:0.7rem;color:#888;font-family:monospace;margin-top:4px">${analysis.snippets[0]}</div>`;
    }
    if (!resultHTML) {
      resultHTML = `<span style="color:#555;font-family:monospace;font-size:0.72rem">Sin menciones relevantes en el texto (${(analysis.textLength/1024).toFixed(1)} KB leÃ­dos)</span>`;
    }

    updateCard(source.id, cardStatus, badgeText, resultHTML);
    results.push({ ...analysis, id: source.id, ok: true });
  }

  // â”€â”€â”€ VEREDICTO FINAL â”€â”€â”€
  log('â•â•â• CALCULANDO VEREDICTO FINAL â•â•â•', 'b');

  const totalYes      = results.reduce((a, r) => a + r.hitsYes.length, 0);
  const totalNo       = results.reduce((a, r) => a + r.hitsNo.length, 0);
  const accessible    = results.filter(r => r.ok).length;
  const noSignalCount = results.filter(r => r.ok && r.hitsYes.length === 0 && r.hitsNo.length === 0).length;

  log(`Fuentes accesibles: ${accessible}/${SOURCES.length}`, accessible > 0 ? 'g' : 'r');
  log(`Total seÃ±ales positivas: ${totalYes}`, totalYes > 0 ? 'g' : 'd');
  log(`Total seÃ±ales negativas: ${totalNo}`, totalNo > 0 ? 'r' : 'd');

  let verdClass, verdIcon, verdText, verdSub;

  if (accessible === 0) {
    verdClass = 'no';
    verdIcon  = 'ğŸš«';
    verdText  = 'No se pudo consultar ninguna fuente';
    verdSub   = 'Todos los proxies fallaron. Esto puede ocurrir por bloqueo de red o Cuba. Intenta de nuevo en unos minutos.';
  } else if (totalYes > totalNo && totalYes > 0) {
    verdClass = 'ok';
    verdIcon  = 'ğŸŸ¢';
    verdText  = `SeÃ±ales positivas detectadas (${totalYes} indicios)`;
    verdSub   = 'Se encontraron menciones de citas disponibles en fuentes pÃºblicas. Esto no garantiza que haya slots hoy â€” entra en sede.maec.gob.es con tus credenciales para confirmar.';
    log('CONCLUSIÃ“N: SEÃ‘ALES POSITIVAS detectadas', 'g');
  } else if (totalNo > totalYes && totalNo > 0) {
    verdClass = 'no';
    verdIcon  = 'ğŸ”´';
    verdText  = `SeÃ±ales negativas â€” probable falta de citas (${totalNo} indicios)`;
    verdSub   = 'Las fuentes consultadas mencionan dificultad para obtener citas o sistema saturado. La situaciÃ³n puede cambiar en cualquier momento.';
    log('CONCLUSIÃ“N: SEÃ‘ALES NEGATIVAS predominan', 'r');
  } else if (noSignalCount === accessible) {
    verdClass = 'maybe';
    verdIcon  = 'ğŸŸ¡';
    verdText  = 'Sin seÃ±ales claras en ninguna fuente';
    verdSub   = `Se leyeron ${accessible} fuente(s) pero ninguna menciona explÃ­citamente disponibilidad ni bloqueo. La informaciÃ³n mÃ¡s reciente puede estar en grupos de WhatsApp o Telegram de la comunidad.`;
    log('CONCLUSIÃ“N: SIN SEÃ‘ALES CLARAS', 'y');
  } else {
    verdClass = 'maybe';
    verdIcon  = 'âš ï¸';
    verdText  = 'SeÃ±ales mixtas â€” situaciÃ³n ambigua';
    verdSub   = `${totalYes} indicios positivos vs ${totalNo} negativos. Recomendamos verificar directamente en la plataforma de citas.`;
    log('CONCLUSIÃ“N: SEÃ‘ALES MIXTAS', 'y');
  }

  setVeredicto(verdClass, verdIcon, verdText, verdSub);
  setGlobalStatus('AnÃ¡lisis completado', true);
  btn.disabled = false;
  log('â•â•â• FIN DE ANÃLISIS â•â•â•', 'b');
}

function setVeredicto(cls, icon, text, sub) {
  const v = document.getElementById('veredicto');
  v.className = `veredicto ${cls}`;
  document.getElementById('verdIcon').textContent = icon;
  document.getElementById('verdText').textContent = text;
  document.getElementById('verdSub').textContent  = sub;
}

function setGlobalStatus(text, done) {
  document.getElementById('globalStatus').textContent = text;
  const dot = document.getElementById('globalDot');
  dot.className = done ? 'pulse done' : 'pulse';
}
</script>
</body>
</html>

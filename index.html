<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”¬ El Toque Scraper v5 â€” trmiExchange</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@800&display=swap');
  :root { --bg:#0a0a0f; --s:#12121a; --b:#1e1e2e; --a:#00ffb3; --w:#ffb300; --e:#ff4d6d; --t:#e0e0f0; --m:#555577; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { background:var(--bg); color:var(--t); font-family:'JetBrains Mono',monospace; padding:1.5rem; }
  h1 { font-family:'Syne',sans-serif; font-size:1.4rem; color:var(--a); margin-bottom:.2rem; }
  .sub { color:var(--m); font-size:.72rem; margin-bottom:1.5rem; }
  .rates { display:grid; grid-template-columns:repeat(3,1fr); gap:.8rem; margin-bottom:1.5rem; }
  .rc { background:var(--s); border:1px solid var(--b); border-radius:10px; padding:1rem; text-align:center; transition:border-color .3s; }
  .rc.ok { border-color:var(--a); } .rc.err { border-color:var(--e); }
  .rl { font-size:.65rem; color:var(--m); text-transform:uppercase; letter-spacing:.08em; margin-bottom:.4rem; }
  .rv { font-size:2rem; font-weight:700; font-family:'Syne',sans-serif; color:var(--a); }
  .rv.p { color:var(--m); font-size:1.2rem; } .rv.f { color:var(--e); font-size:1rem; }
  .ru { font-size:.6rem; color:var(--m); }
  .log { background:#080810; border:1px solid var(--b); border-radius:8px; padding:.8rem; height:440px; overflow-y:auto; font-size:.68rem; line-height:1.9; margin-bottom:1rem; }
  .ll { display:flex; gap:.5rem; }
  .lt { color:var(--m); min-width:5rem; }
  .lm { flex:1; word-break:break-all; }
  .lok .lm { color:var(--a); } .lwarn .lm { color:var(--w); } .lerr .lm { color:var(--e); } .linfo .lm { color:#7788ff; }
  .btns { display:flex; gap:.6rem; flex-wrap:wrap; margin-bottom:.8rem; }
  button { background:var(--s); border:1px solid var(--b); color:var(--t); font-family:'JetBrains Mono',monospace; font-size:.72rem; padding:.5rem 1rem; border-radius:7px; cursor:pointer; transition:all .2s; }
  button:hover { border-color:var(--a); color:var(--a); }
  button.p { background:var(--a); border-color:var(--a); color:#000; font-weight:700; }
  button:disabled { opacity:.4; cursor:not-allowed; }
  pre { background:#080810; border:1px solid var(--b); border-radius:8px; padding:.8rem; margin-top:.8rem; font-size:.62rem; max-height:250px; overflow:auto; color:#aabbcc; white-space:pre-wrap; word-break:break-all; display:none; }
  .winner { background:#001a10; border:1px solid var(--a); border-radius:8px; padding:1rem; margin-bottom:1rem; display:none; }
  .winner h3 { color:var(--a); font-size:.8rem; margin-bottom:.5rem; }
  .winner code { background:#0a0a0f; padding:.3rem .6rem; border-radius:4px; font-size:.7rem; display:block; margin-top:.4rem; line-height:1.8; }
</style>
</head>
<body>
<h1>ğŸ”¬ El Toque Scraper v5</h1>
<p class="sub">Objetivo: extraer tasas de <strong style="color:var(--a)">trmiExchange</strong> en pageProps</p>

<div class="rates">
  <div class="rc" id="card-usd"><div class="rl">ğŸ’µ USD/CUP</div><div class="rv p" id="val-usd">Â·Â·Â·</div><div class="ru">pesos cubanos</div></div>
  <div class="rc" id="card-eur"><div class="rl">ğŸ’¶ EUR/CUP</div><div class="rv p" id="val-eur">Â·Â·Â·</div><div class="ru">pesos cubanos</div></div>
  <div class="rc" id="card-mlc"><div class="rl">ğŸ’³ MLC/CUP</div><div class="rv p" id="val-mlc">Â·Â·Â·</div><div class="ru">pesos cubanos</div></div>
</div>

<div class="winner" id="winnerBox">
  <h3>ğŸ‰ Â¡CÃ³digo listo para script.js!</h3>
  <code id="winnerCode"></code>
</div>

<div class="btns">
  <button class="p" id="btnRun" onclick="runAll()">â–¶ Iniciar</button>
  <button onclick="clearLog()">ğŸ—‘ Limpiar</button>
  <button onclick="toggleRaw()">ğŸ‘ Ver trmiExchange</button>
  <button onclick="copyRaw()">ğŸ“‹ Copiar trmiExchange</button>
</div>

<div class="log" id="logBox"></div>
<pre id="rawBox"></pre>

<script>
const PROXY = url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
const VALID = { usd:{min:200,max:700}, eur:{min:200,max:800}, mlc:{min:150,max:700} };
let rawTrmi = null, running = false;

function log(msg, type="") {
  const box = document.getElementById("logBox");
  const t = new Date().toLocaleTimeString("es",{hour12:false});
  const d = document.createElement("div");
  d.className = `ll l${type}`;
  d.innerHTML = `<span class="lt">[${t}]</span><span class="lm">${esc(msg)}</span>`;
  box.appendChild(d); box.scrollTop = box.scrollHeight;
}
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function clearLog() { document.getElementById("logBox").innerHTML = ""; }
function toggleRaw() {
  const b = document.getElementById("rawBox");
  if (!rawTrmi) { log("Sin datos aÃºn.", "warn"); return; }
  b.style.display = b.style.display==="block" ? "none" : "block";
  b.textContent = JSON.stringify(rawTrmi, null, 2).slice(0, 20000);
}
function copyRaw() {
  if (!rawTrmi) { log("Sin datos aÃºn.", "warn"); return; }
  navigator.clipboard.writeText(JSON.stringify(rawTrmi, null, 2))
    .then(() => log("ğŸ“‹ trmiExchange copiado", "ok"))
    .catch(() => log("Usa ğŸ‘ y copia manualmente.", "warn"));
}
function setRate(c, v) {
  const el = document.getElementById("val-"+c);
  const card = document.getElementById("card-"+c);
  const n = parseInt(v);
  const {min,max} = VALID[c];
  if (!isNaN(n) && n>=min && n<=max) {
    el.textContent = n; el.className = "rv"; card.className = "rc ok"; return true;
  }
  el.textContent = "N/D"; el.className = "rv f"; card.className = "rc err"; return false;
}

async function noSignalFetch(url) {
  const r = await Promise.race([
    fetch(url),
    new Promise((_,rej) => setTimeout(() => rej(new Error("Timeout 15s")), 15000))
  ]);
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r;
}

// â”€â”€ Extraer tasa de un objeto de moneda â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// trmiExchange probablemente tiene estructura como:
// { USD: { tasa: 505, ... }, EUR: { tasa: 565 }, MLC: { tasa: 405 } }
// O puede ser un array: [{ moneda: "USD", tasa: 505 }, ...]
function extractFromTrmi(trmi) {
  log("   ğŸ“Š Tipo: " + (Array.isArray(trmi) ? "Array" : typeof trmi), "");
  
  if (Array.isArray(trmi)) {
    log(`   ğŸ“Š Array con ${trmi.length} elementos`, "");
    log(`   ğŸ“Š Primer elemento: ${JSON.stringify(trmi[0]).slice(0, 300)}`, "");
    
    const result = {};
    for (const item of trmi) {
      // Buscar el cÃ³digo de moneda
      const code = (item.moneda || item.code || item.currency || item.short || 
                    item.short_show || item.ticker || "").toString().toUpperCase();
      // Buscar el valor
      const val = item.tasa ?? item.value ?? item.rate ?? item.precio ?? 
                  item.cup ?? item.last ?? item.promedio ?? item.avg;
      
      if (code && val !== undefined && val !== null) {
        const n = Math.round(parseFloat(val));
        log(`   â†’ ${code}: ${val} â†’ ${n} CUP`, "");
        if (code==='USD' && n>=VALID.usd.min && n<=VALID.usd.max) result.usd = String(n);
        if ((code==='EUR'||code==='ECU') && n>=VALID.eur.min && n<=VALID.eur.max) result.eur = String(n);
        if (code==='MLC' && n>=VALID.mlc.min && n<=VALID.mlc.max) result.mlc = String(n);
      } else if (code) {
        // Mostrar todas las keys numÃ©ricas para diagnÃ³stico
        const nums = Object.entries(item)
          .filter(([,v]) => typeof v === 'number' && v > 50)
          .map(([k,v]) => `${k}=${v}`).join(", ");
        log(`   â†’ ${code}: keys numÃ©ricas > 50: [${nums||'ninguna'}]`, "warn");
        log(`     keys totales: ${Object.keys(item).join(", ")}`, "");
      }
    }
    return result;
    
  } else if (typeof trmi === 'object' && trmi !== null) {
    log(`   ğŸ“Š Object con keys: ${Object.keys(trmi).join(", ")}`, "");
    
    // Puede ser { USD: {...}, EUR: {...}, MLC: {...} }
    const result = {};
    for (const [code, data] of Object.entries(trmi)) {
      const KEY = code.toUpperCase();
      if (!['USD','EUR','ECU','MLC','ZELLE','CAD','GBP','CHF','BRL','MXN'].includes(KEY)) continue;
      
      let val = null;
      if (typeof data === 'number') {
        val = data;
      } else if (typeof data === 'object') {
        val = data.tasa ?? data.value ?? data.rate ?? data.precio ?? data.last ?? 
              data.promedio ?? data.avg ?? data.cup ?? data.informal;
        log(`   â†’ ${KEY}: ${JSON.stringify(data).slice(0,150)}`, "");
      }
      
      if (val !== null) {
        const n = Math.round(parseFloat(val));
        log(`   â†’ ${KEY}: valor=${val} â†’ ${n} CUP`, "");
        if (KEY==='USD' && n>=VALID.usd.min && n<=VALID.usd.max) result.usd = String(n);
        if ((KEY==='EUR'||KEY==='ECU') && n>=VALID.eur.min && n<=VALID.eur.max) result.eur = String(n);
        if (KEY==='MLC' && n>=VALID.mlc.min && n<=VALID.mlc.max) result.mlc = String(n);
      }
    }
    return result;
  }
  
  return {};
}

// â”€â”€ Inspeccionar banksXRates tambiÃ©n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractFromBanks(banksXRates) {
  if (!banksXRates) return {};
  log(`   ğŸ“Š banksXRates tipo: ${Array.isArray(banksXRates)?'Array':typeof banksXRates}`, "");
  if (Array.isArray(banksXRates) && banksXRates.length > 0) {
    log(`   ğŸ“Š Primer elemento: ${JSON.stringify(banksXRates[0]).slice(0,300)}`, "");
  } else if (typeof banksXRates === 'object') {
    log(`   ğŸ“Š Keys: ${Object.keys(banksXRates).slice(0,10).join(", ")}`, "");
  }
  return {};
}

async function runAll() {
  if (running) return;
  running = true;
  document.getElementById("btnRun").disabled = true;
  document.getElementById("winnerBox").style.display = "none";
  ["usd","eur","mlc"].forEach(c => {
    document.getElementById("val-"+c).textContent = "Â·Â·Â·";
    document.getElementById("val-"+c).className = "rv p";
    document.getElementById("card-"+c).className = "rc";
  });

  log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "");
  log("ğŸš€ Fetching HTML de /tasas-de-cambio-cuba...", "info");

  try {
    const r = await noSignalFetch(PROXY("https://eltoque.com/tasas-de-cambio-cuba"));
    const html = await r.text();
    log(`âœ… HTML recibido: ${html.length.toLocaleString()} chars`, "ok");

    const m = html.match(/<script id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);
    if (!m) throw new Error("__NEXT_DATA__ no encontrado en el HTML");
    
    const fullJson = JSON.parse(m[1]);
    const pp = fullJson?.props?.pageProps;
    if (!pp) throw new Error("pageProps no encontrado");

    log(`âœ… pageProps keys: ${Object.keys(pp).join(", ")}`, "ok");
    log("", "");

    // â”€â”€ trmiExchange â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    log("ğŸ” Inspeccionando trmiExchange...", "info");
    if (pp.trmiExchange !== undefined) {
      rawTrmi = pp.trmiExchange;
      const rates = extractFromTrmi(pp.trmiExchange);
      log("", "");
      log(`   Resultado trmiExchange: USD=${rates.usd||'N/D'} EUR=${rates.eur||'N/D'} MLC=${rates.mlc||'N/D'}`, rates.usd?"ok":"warn");
      const ok = setRate("usd",rates.usd) | setRate("eur",rates.eur) | setRate("mlc",rates.mlc);
      
      if (ok) {
        showWinnerCode("trmiExchange", rates);
      }
    } else {
      log("   âš ï¸ trmiExchange no existe o es undefined", "warn");
    }

    // â”€â”€ banksXRates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    log("", "");
    log("ğŸ” Inspeccionando banksXRates...", "info");
    extractFromBanks(pp.banksXRates);

    // â”€â”€ Dump de todos los valores numÃ©ricos en pageProps â”€â”€â”€â”€â”€â”€
    log("", "");
    log("ğŸ” Buscando TODOS los valores numÃ©ricos 200-800 en pageProps...", "info");
    const allNums = [];
    function hunt(obj, path="", depth=0) {
      if (depth>8||!obj||typeof obj!=='object') return;
      for (const [k,v] of Object.entries(obj)) {
        const p = path ? `${path}.${k}` : k;
        if (typeof v==='number') {
          const n = Math.round(v);
          if (n>=200 && n<=800) allNums.push(`${p}=${n}`);
        } else if (typeof v==='object') hunt(v, p, depth+1);
      }
    }
    hunt(pp);
    if (allNums.length > 0) {
      log(`   Valores 200-800 encontrados:`, "warn");
      // Mostrar en grupos de 4
      for (let i=0; i<Math.min(allNums.length,40); i+=4) {
        log(`   ${allNums.slice(i,i+4).join("  |  ")}`, "warn");
      }
    } else {
      log("   âš ï¸ No hay ningÃºn nÃºmero entre 200-800 en pageProps", "err");
      log("   â†’ Las tasas se cargan dinÃ¡micamente (fetch del cliente)", "err");
    }

  } catch(e) {
    log(`âœ— Error: ${e.message}`, "err");
  }

  log("", "");
  log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "");
  log("ğŸ’¡ Si no hay valores 200-800, copia el log completo y pÃ©galo.", "warn");
  
  running = false;
  document.getElementById("btnRun").disabled = false;
}

function showWinnerCode(key, rates) {
  const box = document.getElementById("winnerBox");
  const code = document.getElementById("winnerCode");
  box.style.display = "block";
  code.textContent = 
`// En script.js â€” extracciÃ³n desde pageProps.${key}
const pp = json.props.pageProps;
const trmi = pp.${key};

// trmi es: ${Array.isArray(rawTrmi)?'Array['+rawTrmi.length+']':'Object con keys: '+Object.keys(rawTrmi||{}).join(', ')}
// USD=${rates.usd||'?'} EUR=${rates.eur||'?'} MLC=${rates.mlc||'?'}`;
}

log("ğŸ‘‹ Listo. Pulsa â–¶ para iniciar.", "info");
log("ğŸ¯ Esta versiÃ³n se enfoca en 'trmiExchange' y 'banksXRates'", "");
log("   + dump de TODOS los valores 200-800 en el pageProps completo", "");
</script>
</body>
</html>

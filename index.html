<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>üîç Test El Toque v4 ‚Äì L√≥gica correcta</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: monospace; background: #0d1117; color: #c9d1d9; padding: 20px; }
  h1 { color: #58a6ff; margin-bottom: 6px; }
  p  { color: #8b949e; margin-bottom: 16px; font-size: 13px; }
  .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin: 12px 0; }
  .ok   { color: #3fb950; }
  .err  { color: #f85149; }
  .warn { color: #d29922; }
  .dim  { color: #8b949e; }
  table { border-collapse: collapse; width: 100%; }
  td, th { border: 1px solid #30363d; padding: 8px 12px; text-align: left; font-size: 13px; }
  th { color: #58a6ff; background: #0d1117; }
  tr:hover td { background: #1f2937; }
  .val { font-weight: bold; font-size: 15px; color: #3fb950; }
  pre  { overflow-x: auto; background: #0d1117; padding: 12px; border-radius: 6px;
         font-size: 11px; max-height: 400px; overflow-y: auto; }
  button { background: #238636; color: white; border: none; padding: 10px 20px;
           border-radius: 6px; cursor: pointer; font-size: 14px; margin: 4px; }
  button:hover { background: #2ea043; }
  button.sec { background: #21262d; }
  button.sec:hover { background: #30363d; }
  #timestamp { color: #58a6ff; font-size: 12px; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px;
           font-size: 11px; background: #21262d; color: #8b949e; }
  .badge.new { background: #1f3a1f; color: #3fb950; }
  .badge.ema { background: #2d1f00; color: #d29922; }
  .section-title { color: #8b949e; font-size: 11px; text-transform: uppercase;
                   letter-spacing: 1px; margin: 16px 0 6px; }
  .info-box { background: #1a1f2e; border-left: 3px solid #58a6ff;
              padding: 10px 14px; border-radius: 4px; margin-bottom: 12px;
              font-size: 12px; line-height: 1.6; }
</style>
</head>
<body>
<h1>üîç El Toque ‚Äì Test v4 (umbral corregido: > 10)</h1>
<p>Replica exactamente c√≥mo El Toque decide qu√© valor mostrar: <code>median</code> si hay suficientes muestras, <code>ema_value</code> si hay pocas. <strong>CLA siempre usa <code>ema_value</code>.</strong></p>

<button onclick="runTest()">‚ñ∂ Ejecutar test</button>
<button class="sec" onclick="toggleRaw()">üì¶ JSON crudo</button>
<button class="sec" onclick="clearLog()">üóë Limpiar</button>
<span id="timestamp"></span>

<div class="info-box">
  üìê <strong>L√≥gica:</strong>
  Si <code>count_values &gt;= 11</code> ‚Üí usa <code>median</code> (hay datos suficientes del d√≠a)<br>
  Si <code>count_values &lt; 11</code>  ‚Üí usa <code>ema_value</code> (media m√≥vil hist√≥rica, m√°s estable)<br>
  <span class="warn">‚ö†Ô∏è CLA siempre usa <code>ema_value</code> (independiente del count)</span>
</div>

<div class="card" id="resultado"><em class="dim">Haz clic en "Ejecutar test"‚Ä¶</em></div>

<div class="card" id="all-keys-card" style="display:none">
  <div class="section-title">üóù Todas las claves disponibles en statistics</div>
  <div id="all-keys"></div>
</div>

<div class="card" id="raw-card" style="display:none">
  <div class="section-title">üì¶ JSON crudo ‚Äì monedas objetivo</div>
  <pre id="raw-json"></pre>
</div>

<div class="card">
  <div class="section-title">üìã Log</div>
  <pre id="log"></pre>
</div>

<script>
const MIN_SAMPLES = 11;

const CURRENCIES = [
  { key: 'USD', label: 'D√≥lar USD',        icon: 'üá∫üá∏', decimals: 0 },
  { key: 'ECU', label: 'Euro EUR',          icon: 'üá™üá∫', decimals: 0 },
  { key: 'MLC', label: 'MLC',              icon: 'üí≥',  decimals: 0 },
  { key: 'CAD', label: 'D√≥lar Canadiense', icon: 'üá®üá¶', decimals: 0 },
  { key: 'MXN', label: 'Peso Mexicano',    icon: 'üá≤üáΩ', decimals: 2 },
  { key: 'BRL', label: 'Real Brasile√±o',   icon: 'üáßüá∑', decimals: 2 },
  { key: 'CLA', label: 'Cl√°sica CLA',      icon: 'üíé',  decimals: 2, alwaysEma: true },
];

// CLA siempre usa ema_value; el resto sigue la l√≥gica de count
function elToqueValue(s, alwaysEma = false) {
  if (!s) return { value: null, method: null };
  if (alwaysEma) {
    return { value: s.ema_value ?? s.median, method: 'ema_value ‚≠ê' };
  }
  const count = s.count_values ?? 0;
  if (count >= MIN_SAMPLES && s.median != null) {
    return { value: s.median, method: 'median' };
  }
  if (s.ema_value != null) {
    return { value: s.ema_value, method: 'ema_value' };
  }
  return { value: s.median, method: 'median (fallback)' };
}

const PROXIES = [
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
];
const TARGET = 'https://eltoque.com/tasas-de-cambio-cuba';

function log(msg, cls = '') {
  const pre = document.getElementById('log');
  const ts  = new Date().toLocaleTimeString('es-ES');
  pre.innerHTML += `<span class="${cls}">[${ts}] ${msg}</span>\n`;
  pre.scrollTop  = pre.scrollHeight;
}
function clearLog() {
  document.getElementById('log').innerHTML = '';
  document.getElementById('resultado').innerHTML = '<em class="dim">Limpiado.</em>';
  document.getElementById('all-keys-card').style.display = 'none';
  document.getElementById('raw-card').style.display = 'none';
}
function toggleRaw() {
  const c = document.getElementById('raw-card');
  c.style.display = c.style.display === 'none' ? 'block' : 'none';
}
function fmt(val, dec = 2) {
  return val != null ? Number(val).toFixed(dec) : '<span class="dim">N/A</span>';
}
function fmtVal(val, dec) {
  if (val == null) return '<span class="err">N/A</span>';
  return dec === 0 ? Math.round(val) : Number(val).toFixed(dec);
}

async function fetchViaProxy(proxyFn) {
  const url = proxyFn(TARGET);
  log(`‚è≥ Proxy: ${url.slice(0, 55)}‚Ä¶`);
  const res = await fetch(url, { signal: AbortSignal.timeout(13000) });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.text();
}

function extractStats(html) {
  const match = html.match(/<script id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);
  if (!match) throw new Error('__NEXT_DATA__ no encontrado');
  const json  = JSON.parse(match[1]);
  const stats = json?.props?.pageProps?.trmiExchange?.data?.api?.statistics;
  if (!stats)  throw new Error('trmiExchange.data.api.statistics no encontrado');
  return stats;
}

async function runTest() {
  document.getElementById('resultado').innerHTML = '<em class="dim">‚è≥ Consultando‚Ä¶</em>';
  document.getElementById('all-keys-card').style.display = 'none';
  document.getElementById('raw-card').style.display = 'none';
  document.getElementById('timestamp').textContent = '';
  log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  log('üöÄ Iniciando test v4 ‚Äì ' + new Date().toLocaleString('es-ES'));

  let html = null, proxyUsed = '?';
  for (let i = 0; i < PROXIES.length; i++) {
    try {
      html = await fetchViaProxy(PROXIES[i]);
      proxyUsed = i === 0 ? 'allorigins.win' : 'codetabs.com';
      log(`‚úÖ Proxy ${i+1} OK ‚Äî ${html.length.toLocaleString()} chars`, 'ok');
      break;
    } catch (e) {
      log(`‚ùå Proxy ${i+1} fall√≥: ${e.message}`, 'err');
    }
  }
  if (!html) {
    log('üíÄ Todos los proxies fallaron.', 'err');
    document.getElementById('resultado').innerHTML = '<span class="err">‚ùå Sin datos.</span>';
    return;
  }

  let stats;
  try {
    stats = extractStats(html);
    log(`‚úÖ statistics OK ‚Äî ${Object.keys(stats).length} monedas`, 'ok');
  } catch (e) {
    log(`‚ùå ${e.message}`, 'err');
    document.getElementById('resultado').innerHTML = `<span class="err">‚ùå ${e.message}</span>`;
    return;
  }

  const allKeys = Object.keys(stats).sort();
  document.getElementById('all-keys').innerHTML = allKeys.map(k => {
    const cur = CURRENCIES.find(c => c.key === k);
    const { method } = elToqueValue(stats[k], cur?.alwaysEma ?? false);
    const cls = method?.includes('ema') ? 'badge ema' : 'badge new';
    return `<span class="${cls}" title="${k}: ${method}">${k} (${method ?? '?'})</span> `;
  }).join('');
  document.getElementById('all-keys-card').style.display = 'block';

  const targetKeys = CURRENCIES.reduce((acc, c) => { acc[c.key] = stats[c.key] ?? null; return acc; }, {});
  document.getElementById('raw-json').textContent = JSON.stringify(targetKeys, null, 2);

  let rows = '';
  const results = {};

  for (const cur of CURRENCIES) {
    const s = stats[cur.key];
    if (!s) {
      log(`‚ö†Ô∏è ${cur.key}: no encontrado`, 'warn');
      rows += `<tr><td>${cur.icon} ${cur.label}</td><td><code>${cur.key}</code></td>
               <td colspan="5" class="err">‚ùå No disponible</td></tr>`;
      continue;
    }

    const count = s.count_values ?? 0;
    const { value, method } = elToqueValue(s, cur.alwaysEma ?? false);
    const isEma = method?.includes('ema');
    const displayVal = fmtVal(value, cur.decimals);
    results[cur.key] = value != null ? (cur.decimals === 0 ? Math.round(value) : +value.toFixed(cur.decimals)) : null;

    const methodBadge = isEma
      ? `<span class="badge ema">${method} ‚ö†Ô∏è</span>`
      : `<span class="badge new">median ‚úÖ</span>`;

    const countCls = count < MIN_SAMPLES ? 'warn' : 'ok';

    log(
      `${cur.icon} ${cur.key}: ${method}=${fmt(value, cur.decimals)} | count=${count} | median=${fmt(s.median, cur.decimals)} | ema=${fmt(s.ema_value, cur.decimals)}`,
      isEma ? 'warn' : 'ok'
    );

    rows += `
      <tr>
        <td>${cur.icon} ${cur.label}</td>
        <td><code>${cur.key}</code></td>
        <td class="val">${displayVal} CUP</td>
        <td>${methodBadge}</td>
        <td class="${countCls}">${count}</td>
        <td class="dim">${fmt(s.median, cur.decimals)}</td>
        <td class="dim">${fmt(s.ema_value, cur.decimals)}</td>
      </tr>`;
  }

  const now = new Date().toLocaleString('es-ES');
  document.getElementById('timestamp').textContent = `  ¬∑  ${now}  ¬∑  ${proxyUsed}`;

  document.getElementById('resultado').innerHTML = `
    <div class="section-title">‚úÖ Resultados ‚Äî ${now} ‚Äî proxy: ${proxyUsed}</div>
    <br>
    <table>
      <thead>
        <tr>
          <th>Moneda</th><th>Clave</th><th>Valor mostrado ‚úÖ</th>
          <th>M√©todo usado</th><th>count_values</th><th>median</th><th>ema_value</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;

  log('‚úÖ Test v4 completado', 'ok');
}
</script>
</body>
</html>

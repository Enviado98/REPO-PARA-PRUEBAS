<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üî¨ El Toque Scraper v2</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@800&display=swap');
  :root { --bg:#0a0a0f; --s:#12121a; --b:#1e1e2e; --a:#00ffb3; --w:#ffb300; --e:#ff4d6d; --t:#e0e0f0; --m:#555577; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { background:var(--bg); color:var(--t); font-family:'JetBrains Mono',monospace; padding:1.5rem; }
  h1 { font-family:'Syne',sans-serif; font-size:1.4rem; color:var(--a); margin-bottom:.2rem; }
  .sub { color:var(--m); font-size:.72rem; margin-bottom:1.5rem; }
  .rates { display:grid; grid-template-columns:repeat(3,1fr); gap:.8rem; margin-bottom:1.5rem; }
  .rc { background:var(--s); border:1px solid var(--b); border-radius:10px; padding:1rem; text-align:center; transition:border-color .3s; }
  .rc.ok { border-color:var(--a); } .rc.err { border-color:var(--e); }
  .rl { font-size:.65rem; color:var(--m); text-transform:uppercase; letter-spacing:.08em; margin-bottom:.4rem; }
  .rv { font-size:2rem; font-weight:700; font-family:'Syne',sans-serif; color:var(--a); }
  .rv.p { color:var(--m); font-size:1.2rem; } .rv.f { color:var(--e); font-size:1rem; }
  .ru { font-size:.6rem; color:var(--m); }
  .grid { display:grid; grid-template-columns:1fr 1fr; gap:.6rem; margin-bottom:1.2rem; }
  .mc { background:var(--s); border:1px solid var(--b); border-radius:8px; padding:.7rem 1rem; display:flex; align-items:center; gap:.6rem; }
  .mi { min-width:1.4rem; text-align:center; }
  .mn { flex:1; min-width:0; }
  .mname { font-size:.7rem; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .mst { font-size:.6rem; color:var(--m); }
  .badge { font-size:.58rem; font-weight:700; padding:.18rem .45rem; border-radius:3px; white-space:nowrap; }
  .bp { background:#1e1e2e; color:var(--m); }
  .br { background:#1a1a00; color:var(--w); animation:pulse 1s infinite; }
  .bo { background:#001a10; color:var(--a); }
  .bf { background:#1a0010; color:var(--e); }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:.4} }
  .log { background:#080810; border:1px solid var(--b); border-radius:8px; padding:.8rem; height:280px; overflow-y:auto; font-size:.68rem; line-height:1.9; margin-bottom:1rem; }
  .ll { display:flex; gap:.5rem; }
  .lt { color:var(--m); min-width:5rem; }
  .lm { flex:1; word-break:break-all; }
  .lok .lm { color:var(--a); } .lwarn .lm { color:var(--w); } .lerr .lm { color:var(--e); } .linfo .lm { color:#7788ff; }
  .btns { display:flex; gap:.6rem; flex-wrap:wrap; margin-bottom:.8rem; }
  button { background:var(--s); border:1px solid var(--b); color:var(--t); font-family:'JetBrains Mono',monospace; font-size:.72rem; padding:.5rem 1rem; border-radius:7px; cursor:pointer; transition:all .2s; }
  button:hover { border-color:var(--a); color:var(--a); }
  button.p { background:var(--a); border-color:var(--a); color:#000; font-weight:700; }
  button.p:hover { opacity:.85; }
  button:disabled { opacity:.4; cursor:not-allowed; }
  .html-box { display:none; background:#080810; border:1px solid var(--b); border-radius:8px; padding:.8rem; margin-top:.8rem; font-size:.62rem; height:180px; overflow:auto; color:#aabbcc; white-space:pre-wrap; word-break:break-all; }
  .section-title { font-size:.65rem; color:var(--m); text-transform:uppercase; letter-spacing:.12em; margin-bottom:.5rem; margin-top:1rem; }
</style>
</head>
<body>
<h1>üî¨ El Toque ‚Äî Scraper v2</h1>
<p class="sub">Probando fuentes alternativas ¬∑ eltoque.online + API directa + proxies</p>

<div class="rates">
  <div class="rc" id="card-usd"><div class="rl">üíµ USD/CUP</div><div class="rv p" id="val-usd">¬∑¬∑¬∑</div><div class="ru">pesos cubanos</div></div>
  <div class="rc" id="card-eur"><div class="rl">üí∂ EUR/CUP</div><div class="rv p" id="val-eur">¬∑¬∑¬∑</div><div class="ru">pesos cubanos</div></div>
  <div class="rc" id="card-mlc"><div class="rl">üí≥ MLC/CUP</div><div class="rv p" id="val-mlc">¬∑¬∑¬∑</div><div class="ru">pesos cubanos</div></div>
</div>

<p class="section-title">üì° M√©todos a probar</p>
<div class="grid" id="methodsGrid"></div>

<div class="btns">
  <button class="p" id="btnRun" onclick="runAll()">‚ñ∂ Iniciar prueba</button>
  <button onclick="clearLog()">üóë Limpiar</button>
  <button onclick="toggleHtml()">üëÅ HTML crudo</button>
  <button onclick="copyHtml()">üìã Copiar HTML</button>
</div>

<div class="log" id="logBox"></div>
<div class="html-box" id="htmlBox"></div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// M√âTODOS A PROBAR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// El token del usuario ya expir√≥, pero lo incluimos para diagn√≥stico
const OLD_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmcmVzaCI6ZmFsc2UsImlhdCI6MTc2MzU4NDg4MCwianRpIjoiZmVhZTc2Y2YtODc4Yy00MjdmLTg5MGUtMmQ4MzRmOGE1MzAyIiwidHlwZSI6ImFjY2VzcyIsInN1YiI6IjY5MWUyNWI3ZTkyYmU3N2VhM2RlMjE0ZSIsIm5iZiI6MTc2MzU4NDg4MCwiZXhwIjoxNzk1MTIwODgwfQ.qpxiSsg8ptDTYsXZPnnxC694lUoWmT1qyAvzLUfl1-8";

const today = new Date().toISOString().split('T')[0];

const METHODS = [
  // ‚îÄ‚îÄ Grupo 1: API oficial directa (con token viejo, para ver el error exacto)
  {
    id: "api_direct",
    icon: "üîë",
    name: "API oficial (token viejo)",
    desc: "tasas.eltoque.com/v1/trmi",
    run: async () => {
      const r = await noSignalFetch("https://tasas.eltoque.com/v1/trmi", {
        headers: { 'Authorization': `Bearer ${OLD_TOKEN}` }
      });
      const json = await r.json();
      return extractFromApiJson(json);
    }
  },
  // ‚îÄ‚îÄ Grupo 2: eltoque.online (sitio espejo con HTML est√°tico)
  {
    id: "online_allorigins",
    icon: "üåê",
    name: "eltoque.online via allorigins",
    desc: "Sitio espejo con HTML real",
    run: async () => {
      const target = "https://eltoque.online/tasas-de-cambio-de-moneda-en-cuba-hoy";
      const r = await noSignalFetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(target)}`);
      const html = await r.text();
      return extractFromHtml(html, "eltoque.online");
    }
  },
  {
    id: "online_codetabs",
    icon: "üåê",
    name: "eltoque.online via codetabs",
    desc: "Proxy alternativo",
    run: async () => {
      const target = "https://eltoque.online/tasas-de-cambio-de-moneda-en-cuba-hoy";
      const r = await noSignalFetch(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(target)}`);
      const html = await r.text();
      return extractFromHtml(html, "eltoque.online codetabs");
    }
  },
  // ‚îÄ‚îÄ Grupo 3: eltoque.com /tasas-de-cambio-cuba (URL nueva)
  {
    id: "new_url",
    icon: "üîó",
    name: "eltoque.com/tasas-de-cambio-cuba",
    desc: "URL nueva del sitio",
    run: async () => {
      const target = "https://eltoque.com/tasas-de-cambio-cuba";
      const r = await noSignalFetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(target)}`);
      const html = await r.text();
      return extractFromHtml(html, "new url");
    }
  },
  // ‚îÄ‚îÄ Grupo 4: Next.js data endpoint (SSG JSON)
  {
    id: "nextjs_json",
    icon: "‚ö°",
    name: "Next.js _next/data JSON",
    desc: "Endpoint interno de Next.js",
    run: async () => {
      // Next.js SSG expone los datos en /_next/data/{buildId}/page.json
      // El buildId lo vimos en el HTML: zOiLZtafGePTT1qQZ-PTe
      const buildId = "zOiLZtafGePTT1qQZ-PTe";
      const jsonUrl = `https://eltoque.com/_next/data/${buildId}/tasas-de-cambio-de-moneda-en-cuba-hoy.json`;
      const r = await noSignalFetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(jsonUrl)}`);
      const json = await r.json();
      return extractFromNextJson(json);
    }
  },
  // ‚îÄ‚îÄ Grupo 5: Yadio.io API (alternativa confiable)
  {
    id: "yadio",
    icon: "üí±",
    name: "Yadio.io API (alternativa)",
    desc: "API abierta de tasas Cuba",
    run: async () => {
      const r = await noSignalFetch("https://api.yadio.io/exrates/CUP");
      const json = await r.json();
      // Yadio devuelve CUP como base, necesitamos invertir
      const usd = json.CUP?.USD ? (1 / json.CUP.USD).toFixed(0) : null;
      const eur = json.CUP?.EUR ? (1 / json.CUP.EUR).toFixed(0) : null;
      return { usd, eur, mlc: null, source: "yadio.io" };
    }
  },
  // ‚îÄ‚îÄ Grupo 6: cambio.today
  {
    id: "cambio_today",
    icon: "üìä",
    name: "cambio.today scrape",
    desc: "Sitio de tasas cubanas",
    run: async () => {
      const target = "https://cambio.today/cuc/cup/1";
      const r = await noSignalFetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(target)}`);
      const html = await r.text();
      const m = html.match(/(\d{3,4}(?:[.,]\d+)?)\s*(?:CUP|peso)/i);
      const val = m ? Math.round(parseFloat(m[1].replace(',', '.'))).toString() : null;
      return { usd: val, eur: null, mlc: null, source: "cambio.today" };
    }
  },
];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FETCH SIN AbortSignal (compatible con todos los browsers)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function noSignalFetch(url, opts = {}) {
  const fetchPromise = fetch(url, opts);
  const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error("Timeout 12s")), 12000));
  const res = await Promise.race([fetchPromise, timeout]);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EXTRACTORES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function inRange(v) { const n = parseInt(v); return n >= 100 && n <= 9999; }

function extractFromApiJson(json) {
  // Formato: { tasas: { USD: 380, ECU: 420, MLC: 210 } }
  if (json?.tasas) {
    return {
      usd: json.tasas.USD?.toString(),
      eur: (json.tasas.EUR || json.tasas.ECU)?.toString(),
      mlc: json.tasas.MLC?.toString(),
      source: "API oficial"
    };
  }
  throw new Error("JSON sin formato esperado: " + JSON.stringify(json).slice(0, 200));
}

function extractFromNextJson(json) {
  // Next.js SSG pageProps
  const str = JSON.stringify(json);
  const find = (codes) => {
    for (const code of codes) {
      const m = str.match(new RegExp(`"${code}"[^\\d]{0,20}?(\\d{3,4})`, 'i'));
      if (m && inRange(m[1])) return m[1];
    }
    return null;
  };
  return {
    usd: find(['USD']),
    eur: find(['EUR', 'ECU']),
    mlc: find(['MLC']),
    source: "Next.js SSG JSON"
  };
}

function extractFromHtml(html, sourceName) {
  if (!html || html.length < 500) throw new Error("HTML vac√≠o o muy corto (" + html.length + " chars)");
  
  rawHtml = html;
  log(`üìÑ ${sourceName}: ${html.length.toLocaleString()} chars recibidos`, "");

  // Check if it's also a 404
  if (html.includes('"Page not found"') || html.includes('>404<') || html.includes('P√°gina no encontrada')) {
    throw new Error("El proxy recibi√≥ una p√°gina 404");
  }

  const find = (codes) => {
    for (const code of codes) {
      const patterns = [
        // JSON dentro de script
        new RegExp(`"${code}"\\s*:\\s*(\\d{3,4})`, 'i'),
        // Tabla: c√≥digo seguido de n√∫mero en celda
        new RegExp(`${code}[\\s\\S]{1,150}?<td[^>]*>[^<]*(\\d{3,4})[^<]*<\\/td>`, 'i'),
        // Span/div con n√∫mero
        new RegExp(`>${code}</[^>]+>[\\s\\S]{1,100}?>(\\d{3,4})<`, 'i'),
        // Texto plano
        new RegExp(`\\b${code}\\b[^\\d]{0,25}(\\d{3,4})`, 'i'),
      ];
      for (const pat of patterns) {
        const m = html.match(pat);
        if (m && inRange(m[1])) return m[1];
      }
    }
    return null;
  };

  return {
    usd: find(['USD']),
    eur: find(['EUR', 'ECU']),
    mlc: find(['MLC']),
    source: sourceName
  };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UI
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let rawHtml = "", running = false, winner = null;

function log(msg, type = "") {
  const box = document.getElementById("logBox");
  const t = new Date().toLocaleTimeString("es", { hour12: false });
  const d = document.createElement("div");
  d.className = `ll l${type}`;
  d.innerHTML = `<span class="lt">[${t}]</span><span class="lm">${msg}</span>`;
  box.appendChild(d); box.scrollTop = box.scrollHeight;
}
function clearLog() { document.getElementById("logBox").innerHTML = ""; }
function toggleHtml() {
  const b = document.getElementById("htmlBox");
  if (!rawHtml) { log("Sin HTML capturado a√∫n.", "warn"); return; }
  b.style.display = b.style.display === "block" ? "none" : "block";
  b.textContent = rawHtml.slice(0, 10000);
}
function copyHtml() {
  if (!rawHtml) { log("Sin HTML capturado.", "warn"); return; }
  navigator.clipboard.writeText(rawHtml)
    .then(() => log("üìã HTML copiado (" + rawHtml.length + " chars)", "ok"))
    .catch(() => log("No se pudo copiar autom√°ticamente.", "warn"));
}
function setBadge(id, state, extra = "") {
  const el = document.getElementById("badge-" + id);
  const st = document.getElementById("status-" + id);
  if (!el) return;
  el.className = "badge b" + state[0];
  el.textContent = { p: "ESPERA", r: "PROBANDO...", o: "‚úì OK", f: "‚úó FALLO" }[state[0]] || state;
  if (st && extra) st.textContent = extra;
}
function setRate(c, v) {
  const el = document.getElementById("val-" + c);
  const card = document.getElementById("card-" + c);
  if (v && inRange(v)) {
    el.textContent = v; el.className = "rv"; card.className = "rc ok";
  } else {
    el.textContent = "N/D"; el.className = "rv f"; card.className = "rc err";
  }
}
function buildCards() {
  document.getElementById("methodsGrid").innerHTML = METHODS.map(m => `
    <div class="mc">
      <div class="mi">${m.icon}</div>
      <div class="mn">
        <div class="mname">${m.name}</div>
        <div class="mst" id="status-${m.id}">${m.desc}</div>
      </div>
      <div class="badge bp" id="badge-${m.id}">ESPERA</div>
    </div>`).join("");
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// RUN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runAll() {
  if (running) return;
  running = true; winner = null;
  document.getElementById("btnRun").disabled = true;
  ["usd","eur","mlc"].forEach(c => {
    document.getElementById("val-" + c).textContent = "¬∑¬∑¬∑";
    document.getElementById("val-" + c).className = "rv p";
    document.getElementById("card-" + c).className = "rc";
  });
  METHODS.forEach(m => setBadge(m.id, "pending", m.desc));

  log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", "");
  log("üöÄ Iniciando " + METHODS.length + " m√©todos...", "info");
  log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", "");

  for (const m of METHODS) {
    if (winner) {
      setBadge(m.id, "pending", "Saltado");
      continue;
    }
    setBadge(m.id, "running");
    log(`üîå ${m.name}...`, "info");
    try {
      const rates = await m.run();
      log(`   Resultado: USD=${rates.usd||'null'} EUR=${rates.eur||'null'} MLC=${rates.mlc||'null'}`, "");
      
      if (rates.usd || rates.eur || rates.mlc) {
        winner = { method: m, rates };
        setBadge(m.id, "ok", "¬°GANADOR!");
        setRate("usd", rates.usd); setRate("eur", rates.eur); setRate("mlc", rates.mlc);
        log(`üéâ ¬°√âXITO! Fuente: ${rates.source}`, "ok");
        log(`   üíµ USD = ${rates.usd||'N/D'} CUP`, "ok");
        log(`   üí∂ EUR = ${rates.eur||'N/D'} CUP`, "ok");
        log(`   üí≥ MLC = ${rates.mlc||'N/D'} CUP`, "ok");
        log(`   üîë ID del m√©todo: "${m.id}"`, "ok");
      } else {
        setBadge(m.id, "fail", "Sin tasas");
        log(`   ‚ö†Ô∏è Respondi√≥ pero sin tasas detectables`, "warn");
      }
    } catch (err) {
      setBadge(m.id, "fail", err.message.slice(0, 40));
      log(`   ‚úó Error: ${err.message}`, "err");
    }
    await new Promise(r => setTimeout(r, 300));
  }

  log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", "");
  if (!winner) {
    log("‚ùå Ning√∫n m√©todo devolvi√≥ tasas.", "err");
    log("üí° Pulsa 'üëÅ HTML crudo' para ver qu√© lleg√≥.", "warn");
    log("üí° O considera ingresar las tasas manualmente.", "warn");
    ["usd","eur","mlc"].forEach(c => {
      document.getElementById("val-" + c).textContent = "Error";
      document.getElementById("val-" + c).className = "rv f";
      document.getElementById("card-" + c).className = "rc err";
    });
  } else {
    log(`‚úÖ M√âTODO GANADOR: ${winner.method.id}`, "ok");
    log("   Usa este ID para configurar tu script.js", "ok");
  }

  running = false;
  document.getElementById("btnRun").disabled = false;
}

buildCards();
log("üëã Listo. Pulsa ‚ñ∂ para iniciar.", "info");
log("üîç Esta versi√≥n prueba 7 m√©todos incluyendo fuentes alternativas.", "");
</script>
</body>
</html>

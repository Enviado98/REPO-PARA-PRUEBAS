<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ”¬ Test â€” Tasas + DÃ©ficit</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&display=swap');

  :root {
    --bg: #0c0c0c;
    --panel: #141414;
    --border: #262626;
    --a: #e8ff00;    /* amarillo neÃ³n */
    --b: #00e5ff;    /* cian */
    --e: #ff2d55;
    --m: #555;
    --t: #ddd;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--t);
    font-family: 'Space Mono', monospace;
    min-height: 100vh;
    padding: 1.5rem;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    margin-bottom: 2rem;
    border-bottom: 1px solid var(--border);
    padding-bottom: 1rem;
  }
  header h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.2rem;
    letter-spacing: .08em;
    color: var(--a);
    line-height: 1;
  }
  header p { font-size: .65rem; color: var(--m); }

  /* â”€â”€ GRID â”€â”€ */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

  /* â”€â”€ PANELS â”€â”€ */
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.2rem;
  }
  .panel-title {
    font-size: .6rem;
    color: var(--m);
    text-transform: uppercase;
    letter-spacing: .12em;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: .4rem;
  }
  .panel-title .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--a);
    animation: blink 1.4s infinite;
  }
  @keyframes blink { 0%,100%{opacity:1}50%{opacity:.2} }

  /* â”€â”€ RATES â”€â”€ */
  .rates { display: flex; flex-direction: column; gap: .6rem; }
  .rate-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: .5rem .6rem;
    background: #1a1a1a;
    border-radius: 3px;
    border-left: 3px solid var(--border);
    transition: border-color .3s;
  }
  .rate-row.ok { border-color: var(--a); }
  .rate-row.fail { border-color: var(--e); }
  .rate-label { font-size: .65rem; color: var(--m); }
  .rate-val {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.6rem;
    color: var(--a);
    letter-spacing: .04em;
  }
  .rate-val.pending { color: var(--m); font-size: 1rem; }
  .rate-val.fail { color: var(--e); font-size: .9rem; }
  .rate-unit { font-size: .55rem; color: var(--m); margin-left: .2rem; }

  /* â”€â”€ DEFICIT â”€â”€ */
  .deficit-big {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 4rem;
    color: var(--b);
    letter-spacing: .04em;
    line-height: 1;
    margin-bottom: .3rem;
  }
  .deficit-big.pending { color: var(--m); font-size: 1.5rem; }
  .deficit-big.fail { color: var(--e); font-size: 1.2rem; }
  .deficit-source { font-size: .58rem; color: var(--m); line-height: 1.5; }

  /* â”€â”€ STATUS BADGES â”€â”€ */
  .status-row {
    display: flex;
    gap: .5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }
  .badge {
    font-size: .58rem;
    font-weight: 700;
    padding: .2rem .5rem;
    border-radius: 2px;
    border: 1px solid;
  }
  .badge.pending  { border-color: var(--m);  color: var(--m); }
  .badge.running  { border-color: var(--a);  color: var(--a); animation: blink .7s infinite; }
  .badge.ok       { border-color: var(--a);  color: var(--a); background: #1a1f00; }
  .badge.fail     { border-color: var(--e);  color: var(--e); background: #1f0008; }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btns { display: flex; gap: .6rem; flex-wrap: wrap; margin-bottom: 1rem; }
  button {
    font-family: 'Space Mono', monospace;
    font-size: .7rem;
    padding: .5rem 1rem;
    border-radius: 3px;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--panel);
    color: var(--t);
    transition: all .15s;
  }
  button:hover { border-color: var(--a); color: var(--a); }
  button.primary { background: var(--a); color: #000; border-color: var(--a); font-weight: 700; }
  button.primary:hover { opacity: .85; }
  button:disabled { opacity: .35; cursor: not-allowed; }

  /* â”€â”€ LOG â”€â”€ */
  .log {
    background: #080808;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: .8rem;
    height: 320px;
    overflow-y: auto;
    font-size: .65rem;
    line-height: 1.85;
  }
  .ll { display: flex; gap: .5rem; }
  .lt { color: var(--m); min-width: 5.5rem; flex-shrink: 0; }
  .lm { flex: 1; word-break: break-all; }
  .lok  .lm { color: var(--a); }
  .lwarn .lm { color: #ffaa00; }
  .lerr  .lm { color: var(--e); }
  .linfo .lm { color: var(--b); }

  /* â”€â”€ TITLES LIST â”€â”€ */
  .titles-section { margin-top: 1rem; display: none; }
  .titles-section h3 { font-size: .6rem; color: var(--m); text-transform: uppercase; letter-spacing: .1em; margin-bottom: .6rem; }
  .title-item {
    font-size: .62rem;
    padding: .35rem .6rem;
    border-left: 2px solid var(--border);
    margin-bottom: .3rem;
    color: var(--m);
    line-height: 1.5;
    transition: border-color .2s;
  }
  .title-item.hit { border-color: var(--b); color: var(--t); }
  .title-item .mw-tag { color: var(--b); font-weight: 700; }
</style>
</head>
<body>

<header>
  <h1>DATA TEST</h1>
  <p>El Toque (tasas) + Cubadebate (dÃ©ficit) Â· extracciÃ³n en tiempo real</p>
</header>

<div class="grid">

  <!-- TASAS -->
  <div class="panel">
    <div class="panel-title"><div class="dot"></div> Tasas de cambio â€” El Toque</div>
    <div class="status-row">
      <span class="badge pending" id="badge-eltoque">ESPERA</span>
    </div>
    <div class="rates">
      <div class="rate-row" id="row-usd">
        <span class="rate-label">ðŸ’µ USD</span>
        <span><span class="rate-val pending" id="val-usd">Â·Â·Â·</span><span class="rate-unit">CUP</span></span>
      </div>
      <div class="rate-row" id="row-eur">
        <span class="rate-label">ðŸ’¶ EUR</span>
        <span><span class="rate-val pending" id="val-eur">Â·Â·Â·</span><span class="rate-unit">CUP</span></span>
      </div>
      <div class="rate-row" id="row-mlc">
        <span class="rate-label">ðŸ’³ MLC</span>
        <span><span class="rate-val pending" id="val-mlc">Â·Â·Â·</span><span class="rate-unit">CUP</span></span>
      </div>
    </div>
  </div>

  <!-- DÃ‰FICIT -->
  <div class="panel">
    <div class="panel-title"><div class="dot" style="background:var(--b)"></div> DÃ©ficit energÃ©tico â€” Cubadebate RSS</div>
    <div class="status-row">
      <span class="badge pending" id="badge-deficit">ESPERA</span>
    </div>
    <div class="deficit-big pending" id="deficit-val">Â·Â·Â·</div>
    <div class="deficit-source" id="deficit-source">Esperando...</div>
  </div>

</div>

<!-- CONTROLES -->
<div class="btns">
  <button class="primary" id="btnRun" onclick="runAll()">â–¶ EXTRAER TODO</button>
  <button onclick="clearLog()">ðŸ—‘ Limpiar log</button>
  <button onclick="toggleTitles()">ðŸ“° TÃ­tulos RSS</button>
</div>

<div class="log" id="logBox"></div>
<div class="titles-section" id="titlesSection">
  <h3>ðŸ“° TÃ­tulos del RSS de Cubadebate</h3>
  <div id="titlesList"></div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ELTOQUE_URL  = "https://eltoque.com/tasas-de-cambio-cuba";
const CUBADEBATE_RSS = "http://www.cubadebate.cu/feed/";
const PROXY_1 = url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
const PROXY_2 = url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`;
const VALID = { usd:{min:200,max:700}, eur:{min:200,max:800}, mlc:{min:150,max:700} };

let allRssTitles = [];
let running = false;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function log(msg, type="") {
  const box = document.getElementById("logBox");
  const t = new Date().toLocaleTimeString("es",{hour12:false});
  const d = document.createElement("div");
  d.className = `ll l${type}`;
  d.innerHTML = `<span class="lt">[${t}]</span><span class="lm">${esc(msg)}</span>`;
  box.appendChild(d); box.scrollTop = box.scrollHeight;
}
function clearLog() {
  document.getElementById("logBox").innerHTML = "";
  allRssTitles = [];
  document.getElementById("titlesSection").style.display = "none";
}
function toggleTitles() {
  const s = document.getElementById("titlesSection");
  if (!allRssTitles.length) { log("Sin tÃ­tulos aÃºn.", "warn"); return; }
  s.style.display = s.style.display === "block" ? "none" : "block";
}

function setBadge(id, state, label) {
  const el = document.getElementById(id);
  el.className = "badge " + state;
  el.textContent = label || { pending:"ESPERA", running:"CARGANDO...", ok:"âœ“ OK", fail:"âœ— ERROR" }[state] || state;
}

function setRate(currency, value) {
  const val = document.getElementById(`val-${currency}`);
  const row = document.getElementById(`row-${currency}`);
  const n = parseInt(value);
  const { min, max } = VALID[currency];
  if (!isNaN(n) && n >= min && n <= max) {
    val.textContent = n; val.className = "rate-val"; row.className = "rate-row ok";
  } else {
    val.textContent = value || "N/D"; val.className = "rate-val fail"; row.className = "rate-row fail";
  }
}

async function tryFetch(url, timeoutMs = 13000) {
  const res = await Promise.race([
    fetch(url),
    new Promise((_,rej) => setTimeout(() => rej(new Error("Timeout")), timeoutMs))
  ]);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res;
}

async function fetchViaProxies(targetUrl, label) {
  for (const [i, proxyFn] of [[1, PROXY_1],[2, PROXY_2]]) {
    log(`  ðŸ“¡ ${label} proxy ${i}...`, "");
    try {
      const res = await tryFetch(proxyFn(targetUrl));
      const text = await res.text();
      if (text.length < 500) throw new Error(`Respuesta corta (${text.length} chars)`);
      log(`  âœ… Proxy ${i} OK â€” ${text.length.toLocaleString()} chars`, "ok");
      return text;
    } catch(e) {
      log(`  âœ— Proxy ${i}: ${e.message}`, "err");
    }
  }
  throw new Error("Todos los proxies fallaron");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EL TOQUE â€” extrae de trmiExchange.data.api.statistics
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractElToqueRates(html) {
  const match = html.match(/<script id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);
  if (!match) throw new Error("__NEXT_DATA__ no encontrado");
  const json = JSON.parse(match[1]);
  const stats = json?.props?.pageProps?.trmiExchange?.data?.api?.statistics;
  if (!stats) throw new Error("trmiExchange.data.api.statistics no encontrado");
  return {
    usd: stats.USD?.median  ? String(Math.round(stats.USD.median))  : null,
    eur: stats.ECU?.avg     ? String(Math.round(stats.ECU.avg))     : null,
    mlc: stats.MLC?.median  ? String(Math.round(stats.MLC.median))  : null,
  };
}

async function runElToque() {
  setBadge("badge-eltoque", "running");
  log("â”â” EL TOQUE â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "info");
  try {
    const html = await fetchViaProxies(ELTOQUE_URL, "El Toque");
    const rates = extractElToqueRates(html);
    log(`  USD median  = ${rates.usd}`, "");
    log(`  ECU avg     = ${rates.eur}`, "");
    log(`  MLC median  = ${rates.mlc}`, "");
    setRate("usd", rates.usd);
    setRate("eur", rates.eur);
    setRate("mlc", rates.mlc);
    const ok = rates.usd && parseInt(rates.usd) >= VALID.usd.min;
    setBadge("badge-eltoque", ok ? "ok" : "fail");
    log(ok ? `  ðŸŽ‰ Tasas extraÃ­das correctamente` : `  âš ï¸ Valores fuera de rango`, ok ? "ok" : "warn");
  } catch(e) {
    setBadge("badge-eltoque", "fail");
    log(`  âœ— ${e.message}`, "err");
    setRate("usd", null); setRate("eur", null); setRate("mlc", null);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CUBADEBATE â€” extrae dÃ©ficit del RSS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const UNE_KEYWORDS = ["dÃ©ficit","deficit","afectaciÃ³n","afectacion","uniÃ³n elÃ©ctrica","union electrica","une pronostica","une prevÃ©","une prev"];

function isUNETitle(t) {
  const tl = t.toLowerCase();
  return UNE_KEYWORDS.some(k => tl.includes(k));
}

function extractMW(title) {
  const t = title.toLowerCase();
  const pats = [
    /(\d[\d\s\.]{1,6}\d)\s*mw/i,
    /(\d{3,4})\s*megawatt/i,
  ];
  for (const p of pats) {
    const m = t.match(p);
    if (m) {
      const n = parseInt(m[1].replace(/[\s\.]/g,""));
      if (n >= 100 && n <= 5000) return n;
    }
  }
  return null;
}

function parseTitlesFromXml(xml) {
  return [...xml.matchAll(/<title>(?:<!\[CDATA\[)?([\s\S]*?)(?:\]\]>)?<\/title>/gi)]
    .map(m => m[1].trim())
    .filter(t => t.length > 5)
    .slice(1, 25);
}

async function runCubadebate() {
  setBadge("badge-deficit", "running");
  log("â”â” CUBADEBATE RSS â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "info");

  const defVal = document.getElementById("deficit-val");
  const defSrc = document.getElementById("deficit-source");

  try {
    const xml = await fetchViaProxies(CUBADEBATE_RSS, "Cubadebate");

    const titles = parseTitlesFromXml(xml);
    allRssTitles = titles;
    log(`  ðŸ“° ${titles.length} tÃ­tulos en el RSS`, "");

    // Render tÃ­tulos
    document.getElementById("titlesList").innerHTML = titles.map(t => {
      const une = isUNETitle(t);
      const mw = extractMW(t);
      return `<div class="title-item ${une?'hit':''}">
        ${une?'âš¡':'Â·'} ${esc(t)} ${mw?`<span class="mw-tag">[${mw} MW]</span>`:''}
      </div>`;
    }).join("");

    // Buscar dÃ©ficit
    let found = null, foundTitle = "";
    for (const title of titles) {
      if (!isUNETitle(title)) continue;
      log(`  ðŸ” Candidato UNE: "${title.slice(0,60)}"`, "warn");
      const mw = extractMW(title);
      if (mw) {
        found = mw; foundTitle = title;
        log(`  âœ… MW encontrado: ${mw}`, "ok");
        break;
      }
    }

    if (found) {
      defVal.textContent = `${found} MW`;
      defVal.className = "deficit-big";
      defSrc.textContent = `"${foundTitle.slice(0,80)}${foundTitle.length>80?'â€¦':''}"`;
      setBadge("badge-deficit", "ok");
      log(`  ðŸŽ‰ DÃ©ficit: ${found} MW`, "ok");
    } else {
      defVal.textContent = "N/D";
      defVal.className = "deficit-big fail";
      defSrc.textContent = `RSS obtenido (${titles.length} artÃ­culos) pero sin artÃ­culo de la UNE hoy. Son las ${new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'})} â€” el pronÃ³stico se publica por la maÃ±ana.`;
      setBadge("badge-deficit", "fail", "SIN DATOS HOY");
      log(`  âš ï¸ No hay artÃ­culo de la UNE en el RSS actual`, "warn");
      log(`  â†’ Pulsa 'ðŸ“° TÃ­tulos RSS' para ver quÃ© hay publicado`, "warn");
    }

  } catch(e) {
    setBadge("badge-deficit", "fail");
    defVal.textContent = "Error"; defVal.className = "deficit-big fail";
    defSrc.textContent = e.message;
    log(`  âœ— ${e.message}`, "err");
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAll() {
  if (running) return;
  running = true;
  document.getElementById("btnRun").disabled = true;

  // Reset UI
  ["usd","eur","mlc"].forEach(c => {
    document.getElementById(`val-${c}`).textContent = "Â·Â·Â·";
    document.getElementById(`val-${c}`).className = "rate-val pending";
    document.getElementById(`row-${c}`).className = "rate-row";
  });
  document.getElementById("deficit-val").textContent = "Â·Â·Â·";
  document.getElementById("deficit-val").className = "deficit-big pending";

  // Lanzar ambas en paralelo
  await Promise.all([runElToque(), runCubadebate()]);

  log("", "");
  log("âœ… Prueba completada.", "ok");
  running = false;
  document.getElementById("btnRun").disabled = false;
}

log("ðŸ‘‹ Listo. Pulsa â–¶ EXTRAER TODO para probar ambas fuentes en paralelo.", "info");
log("   El Toque  â†’ trmiExchange.data.api.statistics (USD/EUR/MLC)", "");
log("   Cubadebate â†’ RSS feed (dÃ©ficit MW de la UNE)", "");
</script>
</body>
</html>

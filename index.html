<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitor Citas â€” Consulado EspaÃ±a La Habana</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Syne:wght@400;700;800&display=swap');

  :root {
    --bg:     #0a0a0f;
    --panel:  #0f0f1a;
    --border: #1e1e35;
    --green:  #00ff9d;
    --red:    #ff3c5a;
    --yellow: #ffd24d;
    --blue:   #4da6ff;
    --dim:    #4a4a6a;
    --text:   #c8c8e8;
    --mono:   'Share Tech Mono', monospace;
    --sans:   'Syne', sans-serif;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    padding: 20px;
  }
  body::before {
    content: '';
    position: fixed; inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,157,0.012) 2px, rgba(0,255,157,0.012) 4px);
    pointer-events: none; z-index: 0;
  }

  .wrapper { max-width: 860px; margin: 0 auto; position: relative; z-index: 1; }

  /* HEADER */
  header {
    border-bottom: 1px solid var(--border);
    padding-bottom: 18px; margin-bottom: 24px;
    display: flex; align-items: flex-start; justify-content: space-between;
    gap: 16px; flex-wrap: wrap;
  }
  header h1 { font-size: 1.25rem; font-weight: 800; color: #fff; letter-spacing: -0.5px; }
  header p  { font-size: 0.72rem; color: var(--dim); font-family: var(--mono); margin-top: 4px; }

  .pill {
    display: inline-flex; align-items: center; gap: 7px;
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 20px; padding: 6px 14px;
    font-family: var(--mono); font-size: 0.7rem; white-space: nowrap;
  }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--yellow); flex-shrink: 0; }
  .dot.run  { animation: blink 1.1s infinite; }
  .dot.ok   { background: var(--green); }
  .dot.done { background: var(--green); }
  .dot.err  { background: var(--red); }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.15} }

  /* VEREDICTO */
  .verdict {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px 22px; margin-bottom: 20px;
    display: flex; align-items: center; gap: 18px; min-height: 90px;
    transition: border-color .4s;
  }
  .verdict.ok    { border-color: var(--green); }
  .verdict.maybe { border-color: var(--yellow); }
  .verdict.no    { border-color: var(--red); }
  .verdict-icon  { font-size: 2.8rem; flex-shrink: 0; line-height: 1; }
  .verdict-label { font-size: 0.62rem; font-family: var(--mono); color: var(--dim); text-transform: uppercase; letter-spacing: 2px; }
  .verdict-main  { font-size: 1.05rem; font-weight: 700; color: #fff; margin-top: 5px; line-height: 1.35; }
  .verdict-sub   { font-size: 0.75rem; color: var(--dim); font-family: var(--mono); margin-top: 6px; line-height: 1.5; }

  /* GRID DE FUENTES */
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(255px,1fr)); gap: 12px; margin-bottom: 20px; }

  .card {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 16px; transition: border-color .3s;
  }
  .card.ok    { border-color: rgba(0,255,157,.35); }
  .card.warn  { border-color: rgba(255,210,77,.35); }
  .card.err   { border-color: rgba(255,60,90,.35); }

  .card-head  { display: flex; justify-content: space-between; align-items: center; margin-bottom: 9px; }
  .card-name  { font-size: 0.68rem; font-family: var(--mono); color: var(--dim); text-transform: uppercase; letter-spacing: 1.2px; }

  .badge      { font-size: 0.58rem; font-family: var(--mono); padding: 2px 7px; border-radius: 10px; font-weight: bold; }
  .badge.ok   { background: rgba(0,255,157,.15);  color: var(--green); }
  .badge.warn { background: rgba(255,210,77,.15); color: var(--yellow); }
  .badge.err  { background: rgba(255,60,90,.15);  color: var(--red); }
  .badge.idle { background: rgba(255,255,255,.05);color: var(--dim); }

  .card-body  { font-size: 0.8rem; line-height: 1.5; color: var(--text); }
  .card-body.empty { color: var(--dim); font-family: var(--mono); font-size: 0.7rem; }

  /* SNIPPETS con hits */
  .kw { display: inline-block; border-radius: 3px; padding: 0 5px; font-family: var(--mono); font-size: 0.7rem; }
  .kw.pos { background: rgba(0,255,157,.15); color: var(--green); }
  .kw.neg { background: rgba(255,60,90,.15);  color: var(--red); }
  .snippet { font-size: 0.68rem; color: #666; font-family: var(--mono); margin-top: 6px; line-height: 1.5; border-left: 2px solid var(--border); padding-left: 7px; }

  /* LOG */
  .log-wrap { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  .log-top  { padding: 8px 14px; border-bottom: 1px solid var(--border); font-family: var(--mono); font-size: 0.63rem; color: var(--dim); display: flex; justify-content: space-between; }
  .log-body { padding: 12px 14px; max-height: 240px; overflow-y: auto; font-family: var(--mono); font-size: 0.68rem; line-height: 1.75; }
  .log-body::-webkit-scrollbar { width: 3px; }
  .log-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .ll { display: flex; gap: 10px; }
  .lt { color: var(--dim); flex-shrink: 0; }
  .lm.g { color: var(--green); }
  .lm.y { color: var(--yellow); }
  .lm.r { color: var(--red); }
  .lm.b { color: var(--blue); }
  .lm.d { color: var(--dim); }

  /* BTN */
  .run-btn {
    display: inline-flex; align-items: center; gap: 8px;
    background: transparent; border: 1px solid var(--green); color: var(--green);
    font-family: var(--mono); font-size: 0.78rem; padding: 8px 20px;
    border-radius: 6px; cursor: pointer; transition: all .2s; margin-top: 16px;
  }
  .run-btn:hover:not(:disabled) { background: rgba(0,255,157,.1); }
  .run-btn:disabled { opacity: .35; cursor: not-allowed; }

  /* INFO */
  .info {
    margin-top: 16px; background: var(--panel); border: 1px solid var(--border);
    border-left: 3px solid var(--blue); border-radius: 0 8px 8px 0;
    padding: 12px 16px; font-size: 0.78rem; line-height: 1.65; color: var(--text);
  }
  .info strong { color: #fff; }
  .info a { color: var(--blue); text-decoration: none; }
  .info a:hover { text-decoration: underline; }
  .info code { background: rgba(255,255,255,.07); padding: 1px 5px; border-radius: 3px; font-family: var(--mono); font-size: 0.72rem; }

  @media (max-width: 500px) {
    .grid { grid-template-columns: 1fr; }
    header { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="wrapper">

  <header>
    <div>
      <h1>ğŸ” Monitor de Citas â€” Consulado EspaÃ±a Â· La Habana</h1>
      <p>TEST FUENTES PÃšBLICAS Â· v2.0 Â· Parser corregido Â· +Telegram</p>
    </div>
    <div class="pill">
      <div class="dot run" id="dot"></div>
      <span id="statusTxt">Listo</span>
    </div>
  </header>

  <!-- VEREDICTO -->
  <div class="verdict" id="verdict">
    <div class="verdict-icon" id="vIcon">ğŸ”</div>
    <div>
      <div class="verdict-label">ConclusiÃ³n del anÃ¡lisis</div>
      <div class="verdict-main" id="vMain">Pulsa "Ejecutar" para analizar las fuentes</div>
      <div class="verdict-sub"  id="vSub">Se consultarÃ¡n 5 fuentes pÃºblicas, incluyendo canales de Telegram de la comunidad cubana</div>
    </div>
  </div>

  <!-- FUENTES -->
  <div class="grid" id="grid">
    <div class="card" id="card-telegram1">
      <div class="card-head">
        <span class="card-name">Telegram Â· @alertacitasconsulado</span>
        <span class="badge idle" id="badge-telegram1">PENDIENTE</span>
      </div>
      <div class="card-body empty" id="body-telegram1">Canal colaborativo de alertas de citas</div>
    </div>
    <div class="card" id="card-telegram2">
      <div class="card-head">
        <span class="card-name">Telegram Â· @cubatramite</span>
        <span class="badge idle" id="badge-telegram2">PENDIENTE</span>
      </div>
      <div class="card-body empty" id="body-telegram2">Canal oficial de trÃ¡mites Cuba-EspaÃ±a</div>
    </div>
    <div class="card" id="card-dimecuba">
      <div class="card-head">
        <span class="card-name">DimeCuba Â· Noticias Consulado</span>
        <span class="badge idle" id="badge-dimecuba">PENDIENTE</span>
      </div>
      <div class="card-body empty" id="body-dimecuba">Noticias y comentarios de la comunidad</div>
    </div>
    <div class="card" id="card-directorio">
      <div class="card-head">
        <span class="card-name">DirectorioCubano Â· Foro citas</span>
        <span class="badge idle" id="badge-directorio">PENDIENTE</span>
      </div>
      <div class="card-body empty" id="body-directorio">Foro con experiencias de usuarios</div>
    </div>
    <div class="card" id="card-oficial">
      <div class="card-head">
        <span class="card-name">Exteriores.gob.es Â· Oficial</span>
        <span class="badge idle" id="badge-oficial">PENDIENTE</span>
      </div>
      <div class="card-body empty" id="body-oficial">Web oficial del consulado en La Habana</div>
    </div>
  </div>

  <!-- LOG -->
  <div class="log-wrap">
    <div class="log-top">
      <span>REGISTRO EN VIVO</span>
      <span id="logCount">0 entradas</span>
    </div>
    <div class="log-body" id="logBody">
      <div class="ll"><span class="lt">--:--:--</span><span class="lm d">Sistema listo. Pulsa ejecutar.</span></div>
    </div>
  </div>

  <button class="run-btn" id="runBtn" onclick="run()">â–¶ Ejecutar AnÃ¡lisis</button>

  <div class="info">
    <strong>Fuentes monitorizadas:</strong> Los canales de Telegram <code>@alertacitasconsulado</code> y <code>@cubatramite</code>
    son pÃºblicos y tienen vista web (<code>t.me/s/canal</code>), lo que permite leerlos sin autenticaciÃ³n.
    Son las fuentes mÃ¡s fiables para detectar disponibilidad real ya que la comunidad reporta en tiempo real.<br><br>
    <strong>LimitaciÃ³n principal:</strong> La plataforma de citas <code>sede.maec.gob.es</code> requiere login personal â€”
    no se puede verificar disponibilidad sin credenciales propias. Este monitor detecta <em>seÃ±ales indirectas</em>.<br><br>
    <strong>Para registrarte:</strong> envÃ­a correo a
    <a href="mailto:cog.lahabana.cleg@maec.es">cog.lahabana.cleg@maec.es</a>
    con asunto <code>CITA LEGA</code> + foto con tu carnÃ© de identidad.
  </div>

</div>
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FUENTES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SOURCES = [
  {
    id: 'telegram1',
    url: 'https://t.me/s/alertacitasconsulado',
    // fallback: vista alternativa del mismo canal
    fallback: 'https://t.me/s/alertacitasconsulado?before=9999',
  },
  {
    id: 'telegram2',
    url: 'https://t.me/s/cubatramite',
    fallback: null,
  },
  {
    id: 'dimecuba',
    url: 'https://www.dimecuba.com/revista/nacionalidad-espanola/consulado-espana-en-cuba/',
    fallback: null,
  },
  {
    id: 'directorio',
    url: 'https://www.directoriocubano.info/panorama/nuevo-sistema-de-citas-para-legalizaciones-en-el-consulado-de-espana-en-la-habana/',
    fallback: null,
  },
  {
    id: 'oficial',
    url: 'https://www.exteriores.gob.es/Consulados/lahabana/es/Paginas/index.aspx',
    fallback: null,
  },
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// KEYWORDS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KW_YES = [
  'citas disponibles','cita disponible','nueva fecha','fechas disponibles',
  'hay citas','citas abiertas','se abren citas','nuevas citas',
  'ya hay cita','vuelven las citas','pueden sacar cita',
  'slots disponibles','abre.*cita','cita.*abierta','disponible.*cita',
  'encontr.*cita','sac.*cita','cita.*libre','libre.*cita',
  'pud.*sacar','pud.*cita','logr.*cita','consegui.*cita',
  'hay fecha','fecha libre','acaban de abrir','abrieron citas',
  'maÃ±ana hay','hoy hay cita','esta semana','Â¡hay!'
];
const KW_NO = [
  'no hay citas','sin citas','no hay fechas','no hay horas disponibles',
  'no.*cita disponible','citas agotadas','lista de espera',
  'saturado','no se aceptan','no.*aceptan','sistema.*caÃ­do',
  'no hay nada','meses de espera','imposible.*cita','cita.*imposible',
  'bloqueado','pÃ¡gina.*error','no.*fechas'
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PROXIES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROXY_FNS = [
  u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`,       // devuelve JSON {contents}
  u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,       // devuelve raw
  u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,  // devuelve raw
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let logN = 0;
function log(msg, t = 'd') {
  const body = document.getElementById('logBody');
  const now  = new Date().toLocaleTimeString('es-ES');
  const el   = document.createElement('div');
  el.className = 'll';
  el.innerHTML = `<span class="lt">${now}</span><span class="lm ${t}">${msg}</span>`;
  body.appendChild(el);
  body.scrollTop = body.scrollHeight;
  document.getElementById('logCount').textContent = `${++logN} entradas`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FETCH â€” gestiona JSON wrapper y raw
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchSource(url, fallback) {
  const targets = [url, ...(fallback ? [fallback] : [])];

  for (const target of targets) {
    for (const mkProxy of PROXY_FNS) {
      const proxy = mkProxy(target);
      try {
        log(`Probando â†’ ${proxy.slice(0,65)}â€¦`, 'd');
        const res = await Promise.race([
          fetch(proxy),
          new Promise((_, r) => setTimeout(() => r(new Error('timeout 13s')), 13000))
        ]);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        // â”€â”€â”€ PARSER CORREGIDO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // allorigins /get devuelve: {"contents":"<html>â€¦","status":{â€¦}}
        // allorigins /raw y codetabs devuelven el HTML/texto directamente
        const raw = await res.text();
        let html = raw;

        // Detectar si es JSON wrapper de allorigins
        if (raw.trimStart().startsWith('{') && raw.includes('"contents"')) {
          try {
            const parsed = JSON.parse(raw);
            html = parsed.contents || parsed.content || raw;
          } catch { /* no es JSON vÃ¡lido, usar raw */ }
        }

        if (html.length < 300) throw new Error(`Contenido demasiado corto (${html.length} chars)`);
        log(`âœ“ Obtenido: ${(html.length/1024).toFixed(1)} KB de texto real`, 'g');
        return html;

      } catch (e) {
        log(`âœ— ${e.message}`, 'r');
      }
    }
  }
  return null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANÃLISIS DE TEXTO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function analyze(html) {
  // 1. Extraer texto limpio
  const tmp = document.createElement('div');
  tmp.innerHTML = html
    .replace(/<script[\s\S]*?<\/script>/gi, '')
    .replace(/<style[\s\S]*?<\/style>/gi, '');
  const text = (tmp.innerText || tmp.textContent || '').toLowerCase().trim();

  const hitsYes = KW_YES.filter(kw => new RegExp(kw, 'i').test(text));
  const hitsNo  = KW_NO.filter(kw  => new RegExp(kw, 'i').test(text));

  // Extraer hasta 2 snippets de contexto
  const snippets = [];
  const allHits  = [...hitsYes.slice(0,2), ...hitsNo.slice(0,1)];
  for (const kw of allHits) {
    const idx = text.search(new RegExp(kw, 'i'));
    if (idx === -1) continue;
    const chunk = text.slice(Math.max(0, idx - 55), idx + 110)
      .replace(/\s+/g, ' ').trim();
    snippets.push(`â€¦${chunk}â€¦`);
    if (snippets.length >= 2) break;
  }

  return { hitsYes, hitsNo, snippets, textLen: text.length };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ACTUALIZAR TARJETA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setCard(id, status, badgeText, html) {
  document.getElementById(`card-${id}`).className = `card ${status}`;
  const badge = document.getElementById(`badge-${id}`);
  badge.className   = `badge ${status === 'ok' ? 'ok' : status === 'warn' ? 'warn' : status === 'err' ? 'err' : 'idle'}`;
  badge.textContent = badgeText;
  document.getElementById(`body-${id}`).className = 'card-body';
  document.getElementById(`body-${id}`).innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VEREDICTO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setVerdict(cls, icon, main, sub) {
  const v = document.getElementById('verdict');
  v.className = `verdict ${cls}`;
  document.getElementById('vIcon').textContent = icon;
  document.getElementById('vMain').textContent = main;
  document.getElementById('vSub').textContent  = sub;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function run() {
  const btn = document.getElementById('runBtn');
  btn.disabled = true;
  logN = 0;
  document.getElementById('logBody').innerHTML = '';

  // Reset tarjetas
  SOURCES.forEach(s => setCard(s.id, '', 'CONSULTANDOâ€¦', '<span style="color:var(--dim);font-family:var(--mono);font-size:.7rem">Descargandoâ€¦</span>'));
  setVerdict('', 'â³', 'Analizando fuentesâ€¦', 'Por favor espera, esto puede tardar hasta 1 minuto');
  document.getElementById('dot').className    = 'dot run';
  document.getElementById('statusTxt').textContent = 'Analizandoâ€¦';

  log('â•â•â•â•â•â• INICIO â•â•â•â•â•â•', 'b');

  const results = [];

  for (const src of SOURCES) {
    log(`â–º ${src.id.toUpperCase()} â†’ ${src.url}`, 'b');
    const html = await fetchSource(src.url, src.fallback);

    if (!html) {
      log(`  âœ— Sin contenido utilizable`, 'r');
      setCard(src.id, 'err', 'SIN ACCESO',
        'âš ï¸ Proxy bloqueado o fuente caÃ­da. Prueba de nuevo en unos minutos.');
      results.push({ id: src.id, ok: false, hitsYes: [], hitsNo: [], snippets: [] });
      continue;
    }

    const a = analyze(html);
    log(`  Texto real: ${a.textLen.toLocaleString()} chars`, 'd');
    log(`  âœ“ Pos: ${a.hitsYes.length ? a.hitsYes.join(', ') : 'â€”'}`, a.hitsYes.length ? 'g' : 'd');
    log(`  âœ— Neg: ${a.hitsNo.length  ? a.hitsNo.join(', ')  : 'â€”'}`, a.hitsNo.length  ? 'r' : 'd');

    const hasPos = a.hitsYes.length > 0;
    const hasNeg = a.hitsNo.length  > 0;
    const cStatus = hasPos ? 'ok' : hasNeg ? 'warn' : '';
    const cBadge  = hasPos ? 'âœ“ POSITIVO' : hasNeg ? 'âœ— NEGATIVO' : 'SIN SEÃ‘AL';

    let bodyHTML = '';
    if (hasPos) bodyHTML += `<div style="margin-bottom:7px">ğŸŸ¢ ${a.hitsYes.map(k=>`<span class="kw pos">${k}</span>`).join(' ')}</div>`;
    if (hasNeg) bodyHTML += `<div style="margin-bottom:7px">ğŸ”´ ${a.hitsNo.map(k=>`<span class="kw neg">${k}</span>`).join(' ')}</div>`;
    if (a.snippets.length) bodyHTML += `<div class="snippet">${a.snippets[0]}</div>`;
    if (!bodyHTML) bodyHTML = `<span style="color:var(--dim);font-family:var(--mono);font-size:.7rem">Sin menciones relevantes Â· ${(a.textLen/1024).toFixed(1)} KB leÃ­dos</span>`;

    setCard(src.id, cStatus, cBadge, bodyHTML);
    results.push({ ...a, id: src.id, ok: true });
  }

  // â”€â”€ VEREDICTO FINAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  log('â•â•â•â•â•â• VEREDICTO â•â•â•â•â•â•', 'b');

  const totalYes    = results.reduce((s, r) => s + r.hitsYes.length, 0);
  const totalNo     = results.reduce((s, r) => s + r.hitsNo.length,  0);
  const accessible  = results.filter(r => r.ok).length;
  const noSignal    = results.filter(r => r.ok && !r.hitsYes.length && !r.hitsNo.length).length;
  const telegramOk  = results.filter(r => r.ok && r.id.startsWith('telegram'));

  log(`Fuentes accesibles: ${accessible}/${SOURCES.length}`, accessible > 0 ? 'g' : 'r');
  log(`SeÃ±ales positivas: ${totalYes}  Â·  negativas: ${totalNo}`, 'd');

  let vCls, vIcon, vMain, vSub;

  if (accessible === 0) {
    vCls  = 'no';
    vIcon = 'ğŸš«';
    vMain = 'No se pudo contactar ninguna fuente';
    vSub  = 'Todos los proxies fallaron. Posible bloqueo de red desde Cuba o fallo temporal. Reintenta en 5 min.';
  } else if (totalYes > 0 && totalYes >= totalNo) {
    vCls  = 'ok';
    vIcon = 'ğŸŸ¢';
    vMain = `SeÃ±ales POSITIVAS detectadas â€” posiblemente hay citas (${totalYes} indicio${totalYes>1?'s':''})`;
    vSub  = 'Se encontraron menciones de disponibilidad en fuentes pÃºblicas. Â¡Entra YA a sede.maec.gob.es con tus credenciales para confirmar y reservar antes de que se agoten!';
    log('CONCLUSIÃ“N: SEÃ‘ALES POSITIVAS', 'g');
  } else if (totalNo > 0 && totalNo > totalYes) {
    vCls  = 'no';
    vIcon = 'ğŸ”´';
    vMain = `SeÃ±ales NEGATIVAS â€” probable falta de citas (${totalNo} indicio${totalNo>1?'s':''})`;
    vSub  = 'Las fuentes consultadas sugieren dificultad para obtener citas en este momento. Vuelve a intentarlo mÃ¡s tarde o sigue los canales de Telegram para ser avisado.';
    log('CONCLUSIÃ“N: SEÃ‘ALES NEGATIVAS', 'r');
  } else if (telegramOk.length === 0 && accessible > 0) {
    vCls  = 'maybe';
    vIcon = 'âš ï¸';
    vMain = 'Telegram inaccesible â€” fuente clave bloqueada';
    vSub  = `Se leyeron ${accessible} fuente(s) pero los canales de Telegram (los mÃ¡s fiables) no respondieron. Resultado inconcluso. Prueba de nuevo o accede manualmente a t.me/alertacitasconsulado`;
    log('CONCLUSIÃ“N: TELEGRAM BLOQUEADO', 'y');
  } else {
    vCls  = 'maybe';
    vIcon = 'ğŸŸ¡';
    vMain = 'Sin seÃ±ales claras en este momento';
    vSub  = `Se leyeron ${accessible} fuente(s) con ${(results.reduce((s,r)=>s+r.textLen,0)/1024).toFixed(0)} KB de texto total, sin menciones explÃ­citas de disponibilidad. Esto suele indicar que no hay citas ahora mismo, pero la situaciÃ³n cambia rÃ¡pido.`;
    log('CONCLUSIÃ“N: SIN SEÃ‘ALES', 'y');
  }

  setVerdict(vCls, vIcon, vMain, vSub);
  document.getElementById('dot').className     = `dot ${vCls === 'ok' ? 'ok' : vCls === 'no' ? 'err' : 'done'}`;
  document.getElementById('statusTxt').textContent = 'Completado';
  log('â•â•â•â•â•â• FIN â•â•â•â•â•â•', 'b');
  btn.disabled = false;
}
</script>
</body>
</html>


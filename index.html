<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”¬ El Toque Scraper v4</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@800&display=swap');
  :root { --bg:#0a0a0f; --s:#12121a; --b:#1e1e2e; --a:#00ffb3; --w:#ffb300; --e:#ff4d6d; --t:#e0e0f0; --m:#555577; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { background:var(--bg); color:var(--t); font-family:'JetBrains Mono',monospace; padding:1.5rem; }
  h1 { font-family:'Syne',sans-serif; font-size:1.4rem; color:var(--a); margin-bottom:.2rem; }
  .sub { color:var(--m); font-size:.72rem; margin-bottom:1.5rem; }
  .rates { display:grid; grid-template-columns:repeat(3,1fr); gap:.8rem; margin-bottom:1.5rem; }
  .rc { background:var(--s); border:1px solid var(--b); border-radius:10px; padding:1rem; text-align:center; transition:border-color .3s; }
  .rc.ok { border-color:var(--a); } .rc.err { border-color:var(--e); }
  .rl { font-size:.65rem; color:var(--m); text-transform:uppercase; letter-spacing:.08em; margin-bottom:.4rem; }
  .rv { font-size:2rem; font-weight:700; font-family:'Syne',sans-serif; color:var(--a); }
  .rv.p { color:var(--m); font-size:1.2rem; } .rv.f { color:var(--e); font-size:1rem; }
  .ru { font-size:.6rem; color:var(--m); }
  .log { background:#080810; border:1px solid var(--b); border-radius:8px; padding:.8rem; height:420px; overflow-y:auto; font-size:.68rem; line-height:1.9; margin-bottom:1rem; }
  .ll { display:flex; gap:.5rem; }
  .lt { color:var(--m); min-width:5rem; }
  .lm { flex:1; word-break:break-all; }
  .lok .lm { color:var(--a); } .lwarn .lm { color:var(--w); } .lerr .lm { color:var(--e); } .linfo .lm { color:#7788ff; }
  .btns { display:flex; gap:.6rem; flex-wrap:wrap; margin-bottom:.8rem; }
  button { background:var(--s); border:1px solid var(--b); color:var(--t); font-family:'JetBrains Mono',monospace; font-size:.72rem; padding:.5rem 1rem; border-radius:7px; cursor:pointer; transition:all .2s; }
  button:hover { border-color:var(--a); color:var(--a); }
  button.p { background:var(--a); border-color:var(--a); color:#000; font-weight:700; }
  button.p:hover { opacity:.85; }
  button:disabled { opacity:.4; cursor:not-allowed; }
  pre { background:#080810; border:1px solid var(--b); border-radius:8px; padding:.8rem; margin-top:.8rem; font-size:.62rem; max-height:250px; overflow:auto; color:#aabbcc; white-space:pre-wrap; word-break:break-all; display:none; }
</style>
</head>
<body>
<h1>ğŸ”¬ El Toque Scraper v4</h1>
<p class="sub">InspecciÃ³n directa del JSON de Next.js Â· identificando estructura exacta</p>

<div class="rates">
  <div class="rc" id="card-usd"><div class="rl">ğŸ’µ USD/CUP</div><div class="rv p" id="val-usd">Â·Â·Â·</div><div class="ru">pesos cubanos</div></div>
  <div class="rc" id="card-eur"><div class="rl">ğŸ’¶ EUR/CUP</div><div class="rv p" id="val-eur">Â·Â·Â·</div><div class="ru">pesos cubanos</div></div>
  <div class="rc" id="card-mlc"><div class="rl">ğŸ’³ MLC/CUP</div><div class="rv p" id="val-mlc">Â·Â·Â·</div><div class="ru">pesos cubanos</div></div>
</div>

<div class="btns">
  <button class="p" id="btnRun" onclick="runAll()">â–¶ Iniciar prueba</button>
  <button onclick="clearLog()">ğŸ—‘ Limpiar</button>
  <button onclick="toggleRaw()">ğŸ‘ Ver JSON crudo</button>
  <button onclick="copyRaw()">ğŸ“‹ Copiar JSON</button>
</div>

<div class="log" id="logBox"></div>
<pre id="rawBox"></pre>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Estado
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let rawJson = null;
let running = false;
const VALID = { usd:{min:200,max:700}, eur:{min:200,max:800}, mlc:{min:150,max:700} };
const PROXY = url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
// BuildId extraÃ­do del HTML real de eltoque.com en sesiÃ³n anterior
const BUILD_ID = "zOiLZtafGePTT1qQZ-PTe";

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, type="") {
  const box = document.getElementById("logBox");
  const t = new Date().toLocaleTimeString("es",{hour12:false});
  const d = document.createElement("div");
  d.className = `ll l${type}`;
  d.innerHTML = `<span class="lt">[${t}]</span><span class="lm">${esc(msg)}</span>`;
  box.appendChild(d); box.scrollTop = box.scrollHeight;
}
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function clearLog() { document.getElementById("logBox").innerHTML = ""; }
function toggleRaw() {
  const b = document.getElementById("rawBox");
  if (!rawJson) { log("Sin JSON aÃºn.", "warn"); return; }
  b.style.display = b.style.display === "block" ? "none" : "block";
  b.textContent = JSON.stringify(rawJson, null, 2).slice(0, 15000);
}
function copyRaw() {
  if (!rawJson) { log("Sin JSON aÃºn.", "warn"); return; }
  navigator.clipboard.writeText(JSON.stringify(rawJson, null, 2))
    .then(() => log("ğŸ“‹ JSON copiado", "ok"))
    .catch(() => log("No se pudo copiar. Usa ğŸ‘ y copia manualmente.", "warn"));
}
function setRate(c, v) {
  const el = document.getElementById("val-" + c);
  const card = document.getElementById("card-" + c);
  const n = parseInt(v);
  const { min, max } = VALID[c];
  if (!isNaN(n) && n >= min && n <= max) {
    el.textContent = n; el.className = "rv"; card.className = "rc ok";
  } else {
    el.textContent = v || "N/D"; el.className = "rv f"; card.className = "rc err";
  }
}

async function noSignalFetch(url, opts={}) {
  const r = await Promise.race([
    fetch(url, opts),
    new Promise((_,rej) => setTimeout(() => rej(new Error("Timeout 15s")), 15000))
  ]);
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Extractor principal â€” busca en el array "monedas" del pageProps
// La estructura que vimos es:
// pageProps.monedas = [{ short_show:"USD", tasas:[{ tasa:505, ... }] }, ...]
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractFromPageProps(pageProps) {
  const results = {};

  // Estrategia 1: array "monedas"
  if (pageProps.monedas && Array.isArray(pageProps.monedas)) {
    log(`   ğŸ“¦ Encontrado array 'monedas' con ${pageProps.monedas.length} elementos`, "");
    
    for (const moneda of pageProps.monedas) {
      const code = (moneda.short_show || moneda.codigo || moneda.code || "").toUpperCase();
      log(`   â†’ Moneda: ${code} | keys: ${Object.keys(moneda).join(", ")}`, "");
      
      // Buscar el valor de tasa dentro de la moneda
      // Puede estar en: moneda.tasa, moneda.tasas[0].tasa, moneda.last, moneda.value, etc.
      let value = null;
      
      if (typeof moneda.tasa === 'number') value = moneda.tasa;
      else if (typeof moneda.last === 'number') value = moneda.last;
      else if (typeof moneda.value === 'number') value = moneda.value;
      else if (typeof moneda.rate === 'number') value = moneda.rate;
      else if (typeof moneda.precio === 'number') value = moneda.precio;
      else if (typeof moneda.cup === 'number') value = moneda.cup;
      else if (Array.isArray(moneda.tasas) && moneda.tasas.length > 0) {
        // Tomar el mÃ¡s reciente (Ãºltimo del array o primero segÃºn orden)
        const t = moneda.tasas[moneda.tasas.length - 1];
        value = t.tasa ?? t.value ?? t.rate ?? t.precio ?? null;
        log(`     tasas[] Ãºltimo elemento: ${JSON.stringify(t)}`, "");
      } else if (Array.isArray(moneda.rates) && moneda.rates.length > 0) {
        const t = moneda.rates[moneda.rates.length - 1];
        value = t.tasa ?? t.value ?? t.rate ?? null;
      }

      if (value !== null) {
        const n = Math.round(parseFloat(value));
        log(`     Valor encontrado: ${value} â†’ ${n} CUP`, "");
        if (code === 'USD' && n >= VALID.usd.min && n <= VALID.usd.max) results.usd = String(n);
        if ((code === 'EUR' || code === 'ECU') && n >= VALID.eur.min && n <= VALID.eur.max) results.eur = String(n);
        if (code === 'MLC' && n >= VALID.mlc.min && n <= VALID.mlc.max) results.mlc = String(n);
      } else {
        // Mostrar todos los valores numÃ©ricos para diagnÃ³stico
        const numericKeys = Object.entries(moneda)
          .filter(([,v]) => typeof v === 'number')
          .map(([k,v]) => `${k}:${v}`);
        if (numericKeys.length) log(`     Valores numÃ©ricos: ${numericKeys.join(" | ")}`, "warn");
      }
    }
  }

  // Estrategia 2: buscar propiedades directas USD/EUR/MLC en cualquier nivel
  if (!results.usd) {
    log("   ğŸ” No encontrado en 'monedas', buscando recursivamente...", "warn");
    const found = deepFind(pageProps);
    if (found.usd) results.usd = found.usd;
    if (found.eur) results.eur = found.eur;
    if (found.mlc) results.mlc = found.mlc;
  }

  return results;
}

function deepFind(obj, depth=0) {
  const r = {};
  if (depth > 10 || !obj || typeof obj !== 'object') return r;
  for (const [k, v] of Object.entries(obj)) {
    const key = k.toUpperCase();
    if (typeof v === 'number') {
      const n = Math.round(v);
      if (key === 'USD' && n >= VALID.usd.min && n <= VALID.usd.max) r.usd = String(n);
      if ((key === 'EUR' || key === 'ECU') && n >= VALID.eur.min && n <= VALID.eur.max) r.eur = String(n);
      if (key === 'MLC' && n >= VALID.mlc.min && n <= VALID.mlc.max) r.mlc = String(n);
    }
    if (typeof v === 'object' && !r.usd) {
      const sub = deepFind(v, depth+1);
      if (sub.usd && !r.usd) r.usd = sub.usd;
      if (sub.eur && !r.eur) r.eur = sub.eur;
      if (sub.mlc && !r.mlc) r.mlc = sub.mlc;
    }
  }
  return r;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAll() {
  if (running) return;
  running = true;
  document.getElementById("btnRun").disabled = true;
  ["usd","eur","mlc"].forEach(c => {
    document.getElementById("val-"+c).textContent = "Â·Â·Â·";
    document.getElementById("val-"+c).className = "rv p";
    document.getElementById("card-"+c).className = "rc";
  });

  log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "");
  log("ğŸš€ Iniciando diagnÃ³stico profundo del JSON de Next.js...", "info");

  // â”€â”€ PASO 1: Obtener el JSON del endpoint Next.js SSG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  log("", "");
  log("ğŸ“¡ PASO 1: Fetching Next.js SSG endpoint...", "info");
  const jsonUrl = `https://eltoque.com/_next/data/${BUILD_ID}/tasas-de-cambio-cuba.json`;
  log(`   URL: ${jsonUrl}`, "");

  let pageProps = null;
  try {
    const r = await noSignalFetch(PROXY(jsonUrl));
    const text = await r.text();
    log(`   Respuesta cruda (primeros 400 chars):`, "");
    log(`   ${text.slice(0, 400)}`, "");
    
    const json = JSON.parse(text);
    rawJson = json;
    pageProps = json?.pageProps;
    log(`   âœ… JSON parseado. Keys en pageProps: ${Object.keys(pageProps||{}).join(", ")}`, "ok");
  } catch(e) {
    log(`   âœ— Error: ${e.message}`, "err");
  }

  // â”€â”€ PASO 2: Extraer tasas del JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (pageProps) {
    log("", "");
    log("ğŸ” PASO 2: Extrayendo tasas del JSON...", "info");
    const rates = extractFromPageProps(pageProps);
    log("", "");
    log(`   Resultado final: USD=${rates.usd||'N/D'} EUR=${rates.eur||'N/D'} MLC=${rates.mlc||'N/D'}`, rates.usd ? "ok" : "warn");
    setRate("usd", rates.usd);
    setRate("eur", rates.eur);
    setRate("mlc", rates.mlc);
  }

  // â”€â”€ PASO 3: Si el endpoint Next.js fallÃ³ o estÃ¡ vacÃ­o, intentar con el HTML â”€
  const hasData = pageProps && (
    document.getElementById("val-usd").className === "rv"
  );

  if (!hasData) {
    log("", "");
    log("ğŸ“¡ PASO 3: Fallback â€” fetching HTML completo de /tasas-de-cambio-cuba...", "info");
    try {
      const r = await noSignalFetch(PROXY("https://eltoque.com/tasas-de-cambio-cuba"));
      const html = await r.text();
      log(`   HTML: ${html.length.toLocaleString()} chars`, "");

      // Extraer __NEXT_DATA__
      const m = html.match(/<script id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);
      if (m) {
        try {
          const json = JSON.parse(m[1]);
          rawJson = json;
          log(`   âœ… __NEXT_DATA__ encontrado. Keys: ${Object.keys(json?.props?.pageProps||{}).join(", ")}`, "ok");
          const pp = json?.props?.pageProps;
          if (pp) {
            const rates = extractFromPageProps(pp);
            setRate("usd", rates.usd);
            setRate("eur", rates.eur);
            setRate("mlc", rates.mlc);
            log(`   Resultado: USD=${rates.usd||'N/D'} EUR=${rates.eur||'N/D'} MLC=${rates.mlc||'N/D'}`, rates.usd ? "ok" : "warn");
          }
        } catch(e) {
          log(`   âœ— Error parseando __NEXT_DATA__: ${e.message}`, "err");
        }
      } else {
        log("   âš ï¸ __NEXT_DATA__ no encontrado en el HTML", "warn");
      }
    } catch(e) {
      log(`   âœ— Error fetching HTML: ${e.message}`, "err");
    }
  }

  log("", "");
  log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "");
  log("ğŸ’¡ Si los valores son N/D, pulsa 'ğŸ“‹ Copiar JSON' y pÃ©galo en el chat.", "warn");
  log("   El JSON mostrarÃ¡ exactamente dÃ³nde estÃ¡n las tasas.", "warn");

  running = false;
  document.getElementById("btnRun").disabled = false;
}

log("ğŸ‘‹ Listo. Pulsa â–¶ para diagnÃ³stico profundo.", "info");
log("ğŸ¯ Esta versiÃ³n analiza la estructura exacta del JSON de Next.js.", "");
log("   Valores esperados hoy: USDâ‰ˆ505, EURâ‰ˆ565, MLCâ‰ˆ405", "");
</script>
</body>
</html>

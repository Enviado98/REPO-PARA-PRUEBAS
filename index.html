<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”¬ El Toque Scraper v3</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@800&display=swap');
  :root { --bg:#0a0a0f; --s:#12121a; --b:#1e1e2e; --a:#00ffb3; --w:#ffb300; --e:#ff4d6d; --t:#e0e0f0; --m:#555577; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { background:var(--bg); color:var(--t); font-family:'JetBrains Mono',monospace; padding:1.5rem; }
  h1 { font-family:'Syne',sans-serif; font-size:1.4rem; color:var(--a); margin-bottom:.2rem; }
  .sub { color:var(--m); font-size:.72rem; margin-bottom:1.5rem; }
  .rates { display:grid; grid-template-columns:repeat(3,1fr); gap:.8rem; margin-bottom:1.5rem; }
  .rc { background:var(--s); border:1px solid var(--b); border-radius:10px; padding:1rem; text-align:center; transition:border-color .3s; }
  .rc.ok { border-color:var(--a); } .rc.err { border-color:var(--e); }
  .rl { font-size:.65rem; color:var(--m); text-transform:uppercase; letter-spacing:.08em; margin-bottom:.4rem; }
  .rv { font-size:2rem; font-weight:700; font-family:'Syne',sans-serif; color:var(--a); }
  .rv.p { color:var(--m); font-size:1.2rem; } .rv.f { color:var(--e); font-size:1rem; }
  .ru { font-size:.6rem; color:var(--m); }
  .grid { display:grid; grid-template-columns:1fr 1fr; gap:.6rem; margin-bottom:1.2rem; }
  .mc { background:var(--s); border:1px solid var(--b); border-radius:8px; padding:.7rem 1rem; display:flex; align-items:center; gap:.6rem; }
  .mi { min-width:1.4rem; text-align:center; }
  .mn { flex:1; min-width:0; }
  .mname { font-size:.7rem; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .mst { font-size:.58rem; color:var(--m); }
  .badge { font-size:.58rem; font-weight:700; padding:.18rem .45rem; border-radius:3px; white-space:nowrap; }
  .bp { background:#1e1e2e; color:var(--m); }
  .br { background:#1a1a00; color:var(--w); animation:pulse 1s infinite; }
  .bo { background:#001a10; color:var(--a); }
  .bf { background:#1a0010; color:var(--e); }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:.4} }
  .log { background:#080810; border:1px solid var(--b); border-radius:8px; padding:.8rem; height:340px; overflow-y:auto; font-size:.68rem; line-height:1.9; margin-bottom:1rem; }
  .ll { display:flex; gap:.5rem; }
  .lt { color:var(--m); min-width:5rem; }
  .lm { flex:1; word-break:break-all; }
  .lok .lm { color:var(--a); } .lwarn .lm { color:var(--w); } .lerr .lm { color:var(--e); } .linfo .lm { color:#7788ff; }
  .btns { display:flex; gap:.6rem; flex-wrap:wrap; margin-bottom:.8rem; }
  button { background:var(--s); border:1px solid var(--b); color:var(--t); font-family:'JetBrains Mono',monospace; font-size:.72rem; padding:.5rem 1rem; border-radius:7px; cursor:pointer; transition:all .2s; }
  button:hover { border-color:var(--a); color:var(--a); }
  button.p { background:var(--a); border-color:var(--a); color:#000; font-weight:700; }
  button.p:hover { opacity:.85; }
  button:disabled { opacity:.4; cursor:not-allowed; }
  .html-box { display:none; background:#080810; border:1px solid var(--b); border-radius:8px; padding:.8rem; margin-top:.8rem; font-size:.62rem; height:220px; overflow:auto; color:#aabbcc; white-space:pre-wrap; word-break:break-all; }
  select { background:var(--s); border:1px solid var(--b); color:var(--t); font-family:'JetBrains Mono',monospace; font-size:.7rem; padding:.4rem .6rem; border-radius:6px; cursor:pointer; }
</style>
</head>
<body>
<h1>ğŸ”¬ El Toque Scraper v3</h1>
<p class="sub">ExtracciÃ³n inteligente con validaciÃ³n estricta de tasas cubanas</p>

<div class="rates">
  <div class="rc" id="card-usd"><div class="rl">ğŸ’µ USD/CUP</div><div class="rv p" id="val-usd">Â·Â·Â·</div><div class="ru">pesos cubanos</div></div>
  <div class="rc" id="card-eur"><div class="rl">ğŸ’¶ EUR/CUP</div><div class="rv p" id="val-eur">Â·Â·Â·</div><div class="ru">pesos cubanos</div></div>
  <div class="rc" id="card-mlc"><div class="rl">ğŸ’³ MLC/CUP</div><div class="rv p" id="val-mlc">Â·Â·Â·</div><div class="ru">pesos cubanos</div></div>
</div>

<div class="grid" id="methodsGrid"></div>

<div class="btns">
  <button class="p" id="btnRun" onclick="runAll()">â–¶ Iniciar prueba</button>
  <button onclick="clearLog()">ğŸ—‘ Limpiar</button>
  <button onclick="toggleHtml()">ğŸ‘ HTML crudo</button>
  <button onclick="copyHtml()">ğŸ“‹ Copiar HTML</button>
</div>

<div class="log" id="logBox"></div>
<div class="html-box" id="htmlBox"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VALIDACIÃ“N ESTRICTA DE TASAS CUBANAS
// Reglas de sentido comÃºn:
//   - USD informal en Cuba: entre 300 y 600 CUP (ajustar si cambia mucho)
//   - EUR suele ser 5-15% mÃ¡s que USD
//   - MLC suele ser 50-80% del valor del USD
//   - Los 3 valores NO pueden ser iguales entre sÃ­
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VALID = {
  usd: { min: 200, max: 700 },
  eur: { min: 200, max: 800 },
  mlc: { min: 150, max: 700 },
};

function validateRate(currency, value) {
  const n = parseInt(value);
  if (isNaN(n)) return false;
  const { min, max } = VALID[currency] || { min: 200, max: 800 };
  return n >= min && n <= max;
}

function validateRateSet(rates) {
  // Al menos USD debe ser vÃ¡lido
  if (!rates.usd || !validateRate('usd', rates.usd)) return false;
  // Si tenemos EUR y MLC, no pueden ser iguales a USD
  if (rates.eur && rates.usd === rates.eur) return false;
  if (rates.mlc && rates.usd === rates.mlc) return false;
  return true;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EXTRACTOR INTELIGENTE
// Busca en el HTML patrones especÃ­ficos de tasas de cambio
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractRatesFromHtml(html) {
  // 1. Buscar el __NEXT_DATA__ JSON (Next.js embebe datos del servidor aquÃ­)
  const nextDataMatch = html.match(/<script id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);
  if (nextDataMatch) {
    try {
      const json = JSON.parse(nextDataMatch[1]);
      const result = deepSearchRates(json);
      if (result) {
        log(`   âœ… Encontrado en __NEXT_DATA__`, "ok");
        return result;
      }
    } catch(e) {
      log(`   âš ï¸ __NEXT_DATA__ no parseable: ${e.message}`, "warn");
    }
  }

  // 2. Buscar en scripts inline
  const scripts = [...html.matchAll(/<script[^>]*>([\s\S]*?)<\/script>/g)];
  for (const s of scripts) {
    const content = s[1];
    if (!content.includes('USD') && !content.includes('usd')) continue;
    try {
      // Buscar objetos JSON dentro del script
      const jsonMatches = content.matchAll(/\{[^{}]{20,500}\}/g);
      for (const jm of jsonMatches) {
        try {
          const obj = JSON.parse(jm[0]);
          const r = deepSearchRates(obj);
          if (r) {
            log(`   âœ… Encontrado en script inline`, "ok");
            return r;
          }
        } catch {}
      }
    } catch {}
  }

  // 3. Buscar contexto semÃ¡ntico: "USD" cerca de un nÃºmero en rango vÃ¡lido
  // con contexto de que es una tasa de cambio
  const contextualPatterns = [
    // "USD\n...\n350" o "USD ... 350 CUP"  
    /USD[^<\d]{0,50}(\d{3,4})(?:\.\d+)?(?:\s*CUP)?/gi,
    // Tablas: <td>USD</td><td>350</td>
    />\s*USD\s*<\/[^>]+>[^<]*<[^>]+>\s*(\d{3,4})\s*</gi,
    // JSON: "USD":350 o "USD": "350"
    /"USD"\s*:\s*"?(\d{3,4})"?/gi,
  ];

  const candidates = { usd: [], eur: [], mlc: [] };
  
  for (const pat of contextualPatterns) {
    for (const m of html.matchAll(pat)) {
      const n = parseInt(m[1]);
      if (validateRate('usd', n)) candidates.usd.push(n);
    }
  }

  const eurPatterns = [
    /EUR[^<\d]{0,50}(\d{3,4})(?:\.\d+)?/gi,
    /"EUR"\s*:\s*"?(\d{3,4})"?/gi,
    /"ECU"\s*:\s*"?(\d{3,4})"?/gi,
  ];
  for (const pat of eurPatterns) {
    for (const m of html.matchAll(pat)) {
      const n = parseInt(m[1]);
      if (validateRate('eur', n)) candidates.eur.push(n);
    }
  }

  const mlcPatterns = [
    /MLC[^<\d]{0,50}(\d{3,4})(?:\.\d+)?/gi,
    /"MLC"\s*:\s*"?(\d{3,4})"?/gi,
  ];
  for (const pat of mlcPatterns) {
    for (const m of html.matchAll(pat)) {
      const n = parseInt(m[1]);
      if (validateRate('mlc', n)) candidates.mlc.push(n);
    }
  }

  // Log todos los candidatos para diagnÃ³stico
  log(`   ğŸ”¢ Candidatos USD: [${[...new Set(candidates.usd)].join(', ')||'ninguno'}]`, "");
  log(`   ğŸ”¢ Candidatos EUR: [${[...new Set(candidates.eur)].join(', ')||'ninguno'}]`, "");
  log(`   ğŸ”¢ Candidatos MLC: [${[...new Set(candidates.mlc)].join(', ')||'ninguno'}]`, "");

  // Tomar el valor mÃ¡s frecuente / mÃ¡s probable (el primero vÃ¡lido)
  const usd = candidates.usd.length > 0 ? String(candidates.usd[0]) : null;
  const eur = candidates.eur.length > 0 ? String(candidates.eur[0]) : null;
  const mlc = candidates.mlc.length > 0 ? String(candidates.mlc[0]) : null;

  return { usd, eur, mlc };
}

// Busca recursivamente en un objeto JSON propiedades que parezcan tasas
function deepSearchRates(obj, depth = 0) {
  if (depth > 8 || !obj || typeof obj !== 'object') return null;
  
  const str = JSON.stringify(obj);
  // Si no contiene USD no tiene tasas
  if (!str.includes('USD') && !str.includes('usd')) return null;

  // Buscar directamente propiedades USD/EUR/MLC
  const candidates = {};
  
  function search(o) {
    if (!o || typeof o !== 'object') return;
    for (const [k, v] of Object.entries(o)) {
      const key = k.toUpperCase();
      if (['USD', 'DOLLAR', 'DOLAR'].includes(key) && validateRate('usd', v)) {
        candidates.usd = String(Math.round(v));
      }
      if (['EUR', 'EURO', 'ECU'].includes(key) && validateRate('eur', v)) {
        candidates.eur = String(Math.round(v));
      }
      if (['MLC'].includes(key) && validateRate('mlc', v)) {
        candidates.mlc = String(Math.round(v));
      }
      if (typeof v === 'object') search(v);
    }
  }
  search(obj);
  
  if (candidates.usd) return candidates;
  return null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FETCH SIN AbortSignal
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function noSignalFetch(url, opts = {}) {
  const fetchP = fetch(url, opts);
  const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error("Timeout 15s")), 15000));
  const res = await Promise.race([fetchP, timeout]);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MÃ‰TODOS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROXIES = [
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
];

async function fetchViaProxy(targetUrl, proxyFn) {
  const r = await noSignalFetch(proxyFn(targetUrl));
  const html = await r.text();
  if (!html || html.length < 1000) throw new Error(`HTML demasiado corto (${html.length} chars)`);
  if (html.includes('"Page not found"') || html.includes('PÃ¡gina no encontrada')) throw new Error("PÃ¡gina 404");
  rawHtml = html;
  return html;
}

const METHODS = [
  {
    id: "nextdata_tasas_cuba",
    icon: "âš¡",
    name: "Next.js data: tasas-de-cambio-cuba",
    desc: "Endpoint SSG de Next.js",
    run: async () => {
      const buildId = "zOiLZtafGePTT1qQZ-PTe";
      const jsonUrl = `https://eltoque.com/_next/data/${buildId}/tasas-de-cambio-cuba.json`;
      log(`   ğŸ“¡ Intentando: ${jsonUrl}`, "");
      const r = await noSignalFetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(jsonUrl)}`);
      const text = await r.text();
      log(`   ğŸ“„ Respuesta: ${text.slice(0, 150)}`, "");
      const json = JSON.parse(text);
      return deepSearchRates(json) || {};
    }
  },
  {
    id: "tasas_cuba_allorigins",
    icon: "ğŸŒ",
    name: "tasas-de-cambio-cuba (allorigins)",
    desc: "URL nueva + proxy allorigins",
    run: async () => {
      const html = await fetchViaProxy("https://eltoque.com/tasas-de-cambio-cuba", PROXIES[0]);
      log(`   ğŸ“„ HTML: ${html.length.toLocaleString()} chars`, "");
      return extractRatesFromHtml(html);
    }
  },
  {
    id: "tasas_cuba_codetabs",
    icon: "ğŸŒ",
    name: "tasas-de-cambio-cuba (codetabs)",
    desc: "URL nueva + proxy codetabs",
    run: async () => {
      const html = await fetchViaProxy("https://eltoque.com/tasas-de-cambio-cuba", PROXIES[1]);
      log(`   ğŸ“„ HTML: ${html.length.toLocaleString()} chars`, "");
      return extractRatesFromHtml(html);
    }
  },
  {
    id: "yadio",
    icon: "ğŸ’±",
    name: "Yadio.io API",
    desc: "API abierta de tasas Cuba",
    run: async () => {
      // yadio.io tiene endpoint de tasa informal CUP
      const r = await noSignalFetch("https://api.yadio.io/exrates/CUP");
      const json = await r.json();
      log(`   ğŸ“„ Yadio respuesta: ${JSON.stringify(json).slice(0, 200)}`, "");
      // Yadio da cuÃ¡ntos CUP vale 1 unidad de cada moneda
      const usd = json.CUP?.USD ? String(Math.round(1 / json.CUP.USD)) : null;
      const eur = json.CUP?.EUR ? String(Math.round(1 / json.CUP.EUR)) : null;
      return { usd, eur, mlc: null };
    }
  },
  {
    id: "yadio_json",
    icon: "ğŸ’±",
    name: "Yadio.io /json/USD",
    desc: "Endpoint alternativo de Yadio",
    run: async () => {
      const r = await noSignalFetch("https://api.yadio.io/json/USD");
      const json = await r.json();
      log(`   ğŸ“„ Yadio USD respuesta: ${JSON.stringify(json).slice(0, 300)}`, "");
      const usd = json?.USD?.CUP ? String(Math.round(json.USD.CUP)) : null;
      return { usd, eur: null, mlc: null };
    }
  },
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let rawHtml = "", running = false;

function log(msg, type = "") {
  const box = document.getElementById("logBox");
  const t = new Date().toLocaleTimeString("es", { hour12: false });
  const d = document.createElement("div");
  d.className = `ll l${type}`;
  d.innerHTML = `<span class="lt">[${t}]</span><span class="lm">${escHtml(msg)}</span>`;
  box.appendChild(d); box.scrollTop = box.scrollHeight;
}
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function clearLog() { document.getElementById("logBox").innerHTML = ""; }
function toggleHtml() {
  const b = document.getElementById("htmlBox");
  if (!rawHtml) { log("Sin HTML capturado aÃºn.", "warn"); return; }
  b.style.display = b.style.display === "block" ? "none" : "block";
  b.textContent = rawHtml.slice(0, 12000) + (rawHtml.length > 12000 ? "\n\n[truncado...]" : "");
}
function copyHtml() {
  if (!rawHtml) { log("Sin HTML capturado.", "warn"); return; }
  navigator.clipboard.writeText(rawHtml)
    .then(() => log(`ğŸ“‹ HTML copiado (${rawHtml.length} chars)`, "ok"))
    .catch(() => log("No se pudo copiar. Usa el botÃ³n ğŸ‘.", "warn"));
}
function setBadge(id, state, extra = "") {
  const el = document.getElementById("badge-" + id);
  const st = document.getElementById("status-" + id);
  if (!el) return;
  const states = { p: ["bp","ESPERA"], r: ["br","PROBANDO..."], o: ["bo","âœ“ OK"], f: ["bf","âœ— FALLO"] };
  const [cls, label] = states[state[0]] || ["bp", state];
  el.className = "badge " + cls;
  el.textContent = label;
  if (st && extra) st.textContent = extra;
}
function setRate(c, v) {
  const el = document.getElementById("val-" + c);
  const card = document.getElementById("card-" + c);
  if (v && validateRate(c, v)) {
    el.textContent = v; el.className = "rv"; card.className = "rc ok";
  } else {
    el.textContent = "N/D"; el.className = "rv f"; card.className = "rc err";
  }
}
function buildCards() {
  document.getElementById("methodsGrid").innerHTML = METHODS.map(m => `
    <div class="mc">
      <div class="mi">${m.icon}</div>
      <div class="mn">
        <div class="mname">${m.name}</div>
        <div class="mst" id="status-${m.id}">${m.desc}</div>
      </div>
      <div class="badge bp" id="badge-${m.id}">ESPERA</div>
    </div>`).join("");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RUN â€” ahora NO para al primer resultado, valida todos
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAll() {
  if (running) return;
  running = true;
  document.getElementById("btnRun").disabled = true;
  ["usd","eur","mlc"].forEach(c => {
    document.getElementById("val-" + c).textContent = "Â·Â·Â·";
    document.getElementById("val-" + c).className = "rv p";
    document.getElementById("card-" + c).className = "rc";
  });
  METHODS.forEach(m => setBadge(m.id, "pending", m.desc));

  log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "");
  log(`ğŸš€ Probando ${METHODS.length} mÃ©todos con validaciÃ³n estricta...`, "info");
  log(`ğŸ“ Rangos vÃ¡lidos: USD ${VALID.usd.min}-${VALID.usd.max} | EUR ${VALID.eur.min}-${VALID.eur.max} | MLC ${VALID.mlc.min}-${VALID.mlc.max}`, "");
  log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "");

  const winners = [];

  for (const m of METHODS) {
    setBadge(m.id, "running");
    log(`ğŸ”Œ ${m.name}...`, "info");
    try {
      const rates = await m.run();
      const valid = validateRateSet(rates);
      
      log(`   Resultado bruto: USD=${rates.usd||'null'} EUR=${rates.eur||'null'} MLC=${rates.mlc||'null'}`, "");
      log(`   ValidaciÃ³n: ${valid ? 'âœ… VÃLIDO' : 'âŒ RECHAZADO (valores fuera de rango o iguales)'}`, valid ? "ok" : "warn");

      if (valid) {
        setBadge(m.id, "ok", `USD=${rates.usd}`);
        winners.push({ method: m, rates });
        setRate("usd", rates.usd);
        setRate("eur", rates.eur);
        setRate("mlc", rates.mlc);
        log(`   ğŸ‰ MÃ‰TODO VÃLIDO: ${m.name}`, "ok");
      } else {
        setBadge(m.id, "fail", "Datos invÃ¡lidos");
      }
    } catch (err) {
      setBadge(m.id, "fail", err.message.slice(0, 45));
      log(`   âœ— ${err.message}`, "err");
    }
    log("", "");
    await new Promise(r => setTimeout(r, 400));
  }

  log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "");
  if (winners.length > 0) {
    log(`âœ… ${winners.length} mÃ©todo(s) vÃ¡lido(s):`, "ok");
    winners.forEach(w => log(`   â†’ "${w.method.id}" â†’ USD=${w.rates.usd} EUR=${w.rates.eur} MLC=${w.rates.mlc}`, "ok"));
    log("", "");
    log(`ğŸ† Mejor mÃ©todo para usar: "${winners[0].method.id}"`, "ok");
  } else {
    log("âŒ NingÃºn mÃ©todo pasÃ³ la validaciÃ³n.", "err");
    log("ğŸ’¡ Pulsa 'ğŸ“‹ Copiar HTML' para pegar el HTML aquÃ­ y analizo la estructura.", "warn");
    ["usd","eur","mlc"].forEach(c => {
      document.getElementById("val-" + c).textContent = "---";
      document.getElementById("val-" + c).className = "rv f";
      document.getElementById("card-" + c).className = "rc err";
    });
  }

  running = false;
  document.getElementById("btnRun").disabled = false;
}

buildCards();
log("ğŸ‘‹ Listo. Pulsa â–¶ para iniciar.", "info");
log("ğŸ” v3: validaciÃ³n estricta, todos los mÃ©todos se prueban aunque alguno funcione.", "");
log(`ğŸ“ Tasas aceptadas: USD ${VALID.usd.min}-${VALID.usd.max} CUP, EUR ${VALID.eur.min}-${VALID.eur.max} CUP, MLC ${VALID.mlc.min}-${VALID.mlc.max} CUP`, "");
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ğŸ” Test El Toque v4 â€“ LÃ³gica correcta</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: monospace; background: #0d1117; color: #c9d1d9; padding: 20px; }
  h1 { color: #58a6ff; margin-bottom: 6px; }
  p  { color: #8b949e; margin-bottom: 16px; font-size: 13px; }
  .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin: 12px 0; }
  .ok   { color: #3fb950; }
  .err  { color: #f85149; }
  .warn { color: #d29922; }
  .dim  { color: #8b949e; }
  table { border-collapse: collapse; width: 100%; }
  td, th { border: 1px solid #30363d; padding: 8px 12px; text-align: left; font-size: 13px; }
  th { color: #58a6ff; background: #0d1117; }
  tr:hover td { background: #1f2937; }
  .val { font-weight: bold; font-size: 15px; color: #3fb950; }
  pre  { overflow-x: auto; background: #0d1117; padding: 12px; border-radius: 6px;
         font-size: 11px; max-height: 400px; overflow-y: auto; }
  button { background: #238636; color: white; border: none; padding: 10px 20px;
           border-radius: 6px; cursor: pointer; font-size: 14px; margin: 4px; }
  button:hover { background: #2ea043; }
  button.sec { background: #21262d; }
  button.sec:hover { background: #30363d; }
  #timestamp { color: #58a6ff; font-size: 12px; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px;
           font-size: 11px; background: #21262d; color: #8b949e; }
  .badge.new { background: #1f3a1f; color: #3fb950; }
  .badge.ema { background: #2d1f00; color: #d29922; }
  .section-title { color: #8b949e; font-size: 11px; text-transform: uppercase;
                   letter-spacing: 1px; margin: 16px 0 6px; }
  .info-box { background: #1a1f2e; border-left: 3px solid #58a6ff;
              padding: 10px 14px; border-radius: 4px; margin-bottom: 12px;
              font-size: 12px; line-height: 1.6; }
</style>
</head>
<body>
<h1>ğŸ” El Toque â€“ Test v4 (umbral corregido: > 10)</h1>
<p>Replica exactamente cÃ³mo El Toque decide quÃ© valor mostrar: <code>median</code> si hay suficientes muestras, <code>ema_value</code> si hay pocas.</p>

<button onclick="runTest()">â–¶ Ejecutar test</button>
<button class="sec" onclick="toggleRaw()">ğŸ“¦ JSON crudo</button>
<button class="sec" onclick="clearLog()">ğŸ—‘ Limpiar</button>
<span id="timestamp"></span>

<div class="info-box">
  ğŸ“ <strong>LÃ³gica de El Toque:</strong>
  Si <code>count_values > 10</code> â†’ usa <code>median</code> (hay datos suficientes del dÃ­a)<br>
  Si <code>count_values &lt;= 10</code>  â†’ usa <code>ema_value</code> (media mÃ³vil histÃ³rica, mÃ¡s estable)<br>
  <span class="warn">âš ï¸ MXN (10 muestras, lÃ­mite exacto) y CLA/BRL (pocas muestras) â†’ usan <code>ema_value</code></span>
</div>

<div class="card" id="resultado"><em class="dim">Haz clic en "Ejecutar test"â€¦</em></div>

<div class="card" id="all-keys-card" style="display:none">
  <div class="section-title">ğŸ— Todas las claves disponibles en statistics</div>
  <div id="all-keys"></div>
</div>

<div class="card" id="raw-card" style="display:none">
  <div class="section-title">ğŸ“¦ JSON crudo â€“ monedas objetivo</div>
  <pre id="raw-json"></pre>
</div>

<div class="card">
  <div class="section-title">ğŸ“‹ Log</div>
  <pre id="log"></pre>
</div>

<script>
// â”€â”€â”€ Umbral: si count_values < MIN_SAMPLES â†’ usar ema_value en vez de median
const MIN_SAMPLES = 11; // El Toque usa > 10 (estricto)

// â”€â”€â”€ Monedas objetivo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CURRENCIES = [
  { key: 'USD', label: 'DÃ³lar USD',        icon: 'ğŸ‡ºğŸ‡¸', decimals: 0 },
  { key: 'ECU', label: 'Euro EUR',          icon: 'ğŸ‡ªğŸ‡º', decimals: 0 },
  { key: 'MLC', label: 'MLC',              icon: 'ğŸ’³',  decimals: 0 },
  { key: 'CAD', label: 'DÃ³lar Canadiense', icon: 'ğŸ‡¨ğŸ‡¦', decimals: 0 },
  { key: 'MXN', label: 'Peso Mexicano',    icon: 'ğŸ‡²ğŸ‡½', decimals: 2 },
  { key: 'BRL', label: 'Real BrasileÃ±o',   icon: 'ğŸ‡§ğŸ‡·', decimals: 2 },
  { key: 'CLA', label: 'ClÃ¡sica CLA',      icon: 'ğŸ’',  decimals: 2 },
];

// â”€â”€â”€ FunciÃ³n clave: replica la lÃ³gica de El Toque â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Devuelve { value, method } donde method es 'median' o 'ema_value'
function elToqueValue(s) {
  if (!s) return { value: null, method: null };
  const count = s.count_values ?? 0;
  if (count >= MIN_SAMPLES && s.median != null) {
    return { value: s.median, method: 'median' };
  }
  if (s.ema_value != null) {
    return { value: s.ema_value, method: 'ema_value' };
  }
  return { value: s.median, method: 'median (fallback)' };
}

// â”€â”€â”€ Proxies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROXIES = [
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
];
const TARGET = 'https://eltoque.com/tasas-de-cambio-cuba';

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, cls = '') {
  const pre = document.getElementById('log');
  const ts  = new Date().toLocaleTimeString('es-ES');
  pre.innerHTML += `<span class="${cls}">[${ts}] ${msg}</span>\n`;
  pre.scrollTop  = pre.scrollHeight;
}
function clearLog() {
  document.getElementById('log').innerHTML = '';
  document.getElementById('resultado').innerHTML = '<em class="dim">Limpiado.</em>';
  document.getElementById('all-keys-card').style.display = 'none';
  document.getElementById('raw-card').style.display = 'none';
}
function toggleRaw() {
  const c = document.getElementById('raw-card');
  c.style.display = c.style.display === 'none' ? 'block' : 'none';
}
function fmt(val, dec = 2) {
  return val != null ? Number(val).toFixed(dec) : '<span class="dim">N/A</span>';
}
function fmtVal(val, dec) {
  if (val == null) return '<span class="err">N/A</span>';
  return dec === 0 ? Math.round(val) : Number(val).toFixed(dec);
}

// â”€â”€â”€ Fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchViaProxy(proxyFn) {
  const url = proxyFn(TARGET);
  log(`â³ Proxy: ${url.slice(0, 55)}â€¦`);
  const res = await fetch(url, { signal: AbortSignal.timeout(13000) });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.text();
}

function extractStats(html) {
  const match = html.match(/<script id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);
  if (!match) throw new Error('__NEXT_DATA__ no encontrado');
  const json  = JSON.parse(match[1]);
  const stats = json?.props?.pageProps?.trmiExchange?.data?.api?.statistics;
  if (!stats)  throw new Error('trmiExchange.data.api.statistics no encontrado');
  return stats;
}

// â”€â”€â”€ Test principal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runTest() {
  document.getElementById('resultado').innerHTML = '<em class="dim">â³ Consultandoâ€¦</em>';
  document.getElementById('all-keys-card').style.display = 'none';
  document.getElementById('raw-card').style.display = 'none';
  document.getElementById('timestamp').textContent = '';
  log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  log('ğŸš€ Iniciando test v4 â€“ ' + new Date().toLocaleString('es-ES'));

  let html = null, proxyUsed = '?';
  for (let i = 0; i < PROXIES.length; i++) {
    try {
      html = await fetchViaProxy(PROXIES[i]);
      proxyUsed = i === 0 ? 'allorigins.win' : 'codetabs.com';
      log(`âœ… Proxy ${i+1} OK â€” ${html.length.toLocaleString()} chars`, 'ok');
      break;
    } catch (e) {
      log(`âŒ Proxy ${i+1} fallÃ³: ${e.message}`, 'err');
    }
  }
  if (!html) {
    log('ğŸ’€ Todos los proxies fallaron.', 'err');
    document.getElementById('resultado').innerHTML = '<span class="err">âŒ Sin datos.</span>';
    return;
  }

  let stats;
  try {
    stats = extractStats(html);
    log(`âœ… statistics OK â€” ${Object.keys(stats).length} monedas`, 'ok');
  } catch (e) {
    log(`âŒ ${e.message}`, 'err');
    document.getElementById('resultado').innerHTML = `<span class="err">âŒ ${e.message}</span>`;
    return;
  }

  // Todas las claves
  const allKeys = Object.keys(stats).sort();
  document.getElementById('all-keys').innerHTML = allKeys.map(k => {
    const { method } = elToqueValue(stats[k]);
    const cls = method === 'ema_value' ? 'badge ema' : 'badge new';
    return `<span class="${cls}" title="${k}: ${method}">${k} (${method ?? '?'})</span> `;
  }).join('');
  document.getElementById('all-keys-card').style.display = 'block';

  // JSON crudo
  const targetKeys = CURRENCIES.reduce((acc, c) => { acc[c.key] = stats[c.key] ?? null; return acc; }, {});
  document.getElementById('raw-json').textContent = JSON.stringify(targetKeys, null, 2);

  // Tabla
  let rows = '';
  const results = {};

  for (const cur of CURRENCIES) {
    const s = stats[cur.key];
    if (!s) {
      log(`âš ï¸ ${cur.key}: no encontrado`, 'warn');
      rows += `<tr><td>${cur.icon} ${cur.label}</td><td><code>${cur.key}</code></td>
               <td colspan="5" class="err">âŒ No disponible</td></tr>`;
      continue;
    }

    const count        = s.count_values ?? 0;
    const { value, method } = elToqueValue(s);
    const median       = s.median;
    const ema          = s.ema_value;
    const isEma        = method === 'ema_value';
    const displayVal   = fmtVal(value, cur.decimals);
    results[cur.key]   = value != null ? (cur.decimals === 0 ? Math.round(value) : +value.toFixed(cur.decimals)) : null;

    const methodBadge = isEma
      ? `<span class="badge ema" title="pocas muestras (${count})">ema_value âš ï¸</span>`
      : `<span class="badge new" title="${count} muestras">median âœ…</span>`;

    const countCls = count < MIN_SAMPLES ? 'warn' : 'ok';

    log(
      `${cur.icon} ${cur.key}: ${method}=${fmt(value, cur.decimals)} | count=${count} | median=${fmt(median, cur.decimals)} | ema=${fmt(ema, cur.decimals)}`,
      isEma ? 'warn' : 'ok'
    );

    rows += `
      <tr>
        <td>${cur.icon} ${cur.label}</td>
        <td><code>${cur.key}</code></td>
        <td class="val">${displayVal} CUP</td>
        <td>${methodBadge}</td>
        <td class="${countCls}">${count}</td>
        <td class="dim">${fmt(median, cur.decimals)}</td>
        <td class="dim">${fmt(ema, cur.decimals)}</td>
      </tr>`;
  }

  const now = new Date().toLocaleString('es-ES');
  document.getElementById('timestamp').textContent = `  Â·  ${now}  Â·  ${proxyUsed}`;

  document.getElementById('resultado').innerHTML = `
    <div class="section-title">âœ… Resultados â€” ${now} â€” proxy: ${proxyUsed}</div>
    <br>
    <table>
      <thead>
        <tr>
          <th>Moneda</th>
          <th>Clave</th>
          <th>Valor mostrado âœ…</th>
          <th>MÃ©todo usado</th>
          <th>count_values</th>
          <th>median</th>
          <th>ema_value</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    <br>
    <div class="section-title">ğŸ“‹ Snippet para script.js (lÃ³gica correcta)</div>
    <pre>${generateSnippet(results)}</pre>
  `;

  log('âœ… Test v4 completado', 'ok');
}

function generateSnippet(results) {
  return `// LÃ³gica correcta: median si count_values >= ${MIN_SAMPLES}, sino ema_value
function elToqueVal(s) {
    if (!s) return null;
    const v = (s.count_values ?? 0) >= ${MIN_SAMPLES} && s.median != null
        ? s.median
        : s.ema_value ?? s.median;
    return v != null ? String(Math.round(v * 100) / 100) : null;
}

return {
    usd: elToqueVal(stats.USD),   // siempre median (muchas muestras)
    eur: elToqueVal(stats.ECU),   // siempre median
    mlc: elToqueVal(stats.MLC),   // siempre median
    cad: elToqueVal(stats.CAD),   // siempre median
    mxn: elToqueVal(stats.MXN),   // ema_value cuando hay pocas muestras
    brl: elToqueVal(stats.BRL),   // casi siempre ema_value
    cla: elToqueVal(stats.CLA),   // casi siempre ema_value
};

// Valores actuales detectados:
${Object.entries(results).map(([k, v]) => `// ${k}: ${v} CUP`).join('\n')}`;
}
</script>
</body>
</html>

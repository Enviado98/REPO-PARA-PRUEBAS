<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”¬ El Toque Scraper v6 â€” Contexto</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@800&display=swap');
  :root { --bg:#0a0a0f; --s:#12121a; --b:#1e1e2e; --a:#00ffb3; --w:#ffb300; --e:#ff4d6d; --t:#e0e0f0; --m:#555577; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { background:var(--bg); color:var(--t); font-family:'JetBrains Mono',monospace; padding:1.5rem; }
  h1 { font-family:'Syne',sans-serif; font-size:1.4rem; color:var(--a); margin-bottom:.2rem; }
  .sub { color:var(--m); font-size:.72rem; margin-bottom:1.5rem; }
  .log { background:#080810; border:1px solid var(--b); border-radius:8px; padding:.8rem; height:500px; overflow-y:auto; font-size:.68rem; line-height:1.9; margin-bottom:1rem; }
  .ll { display:flex; gap:.5rem; }
  .lt { color:var(--m); min-width:5rem; }
  .lm { flex:1; word-break:break-all; }
  .lok .lm { color:var(--a); } .lwarn .lm { color:var(--w); } .lerr .lm { color:var(--e); } .linfo .lm { color:#7788ff; }
  .ctx { background:#0d0d1a; border-left:3px solid var(--w); padding:.4rem .6rem; margin:.2rem 0; font-size:.63rem; line-height:1.6; color:#ccc; white-space:pre-wrap; word-break:break-all; }
  .ctx .hi { background:#3a2a00; color:var(--w); font-weight:700; padding:0 2px; }
  .btns { display:flex; gap:.6rem; flex-wrap:wrap; margin-bottom:.8rem; }
  button { background:var(--s); border:1px solid var(--b); color:var(--t); font-family:'JetBrains Mono',monospace; font-size:.72rem; padding:.5rem 1rem; border-radius:7px; cursor:pointer; transition:all .2s; }
  button:hover { border-color:var(--a); color:var(--a); }
  button.p { background:var(--a); border-color:var(--a); color:#000; font-weight:700; }
  button:disabled { opacity:.4; cursor:not-allowed; }
</style>
</head>
<body>
<h1>ğŸ”¬ El Toque Scraper v6</h1>
<p class="sub">Muestra el contexto exacto de cada nÃºmero candidato en el HTML</p>

<div class="btns">
  <button class="p" id="btnRun" onclick="runAll()">â–¶ Analizar contexto</button>
  <button onclick="clearLog()">ğŸ—‘ Limpiar</button>
</div>

<div class="log" id="logBox"></div>

<script>
const PROXY = url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
let running = false;

function log(msg, type="", isHtml=false) {
  const box = document.getElementById("logBox");
  const t = new Date().toLocaleTimeString("es",{hour12:false});
  const d = document.createElement("div");
  d.className = `ll l${type}`;
  if (isHtml) {
    d.innerHTML = `<span class="lt">[${t}]</span><span class="lm">${msg}</span>`;
  } else {
    d.innerHTML = `<span class="lt">[${t}]</span><span class="lm">${esc(msg)}</span>`;
  }
  box.appendChild(d); box.scrollTop = box.scrollHeight;
}
function logCtx(label, context, highlight) {
  const box = document.getElementById("logBox");
  const div = document.createElement("div");
  div.className = "ctx";
  const escaped = esc(context).replace(
    new RegExp(esc(highlight), 'g'),
    `<span class="hi">${esc(highlight)}</span>`
  );
  div.innerHTML = `<strong style="color:var(--w)">${esc(label)}</strong>\n${escaped}`;
  box.appendChild(div); box.scrollTop = box.scrollHeight;
}
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function clearLog() { document.getElementById("logBox").innerHTML = ""; }

async function runAll() {
  if (running) return;
  running = true;
  document.getElementById("btnRun").disabled = true;

  log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "");
  log("ğŸš€ Fetching HTML...", "info");

  try {
    const res = await Promise.race([
      fetch(PROXY("https://eltoque.com/tasas-de-cambio-cuba")),
      new Promise((_,rej) => setTimeout(() => rej(new Error("Timeout 15s")), 15000))
    ]);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const html = await res.text();
    log(`âœ… HTML: ${html.length.toLocaleString()} chars`, "ok");

    // â”€â”€ 1. Mostrar el __NEXT_DATA__ completo (primeros 3000 chars)
    log("", "");
    log("ğŸ“¦ __NEXT_DATA__ (primeros 3000 chars):", "info");
    const nd = html.match(/<script id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);
    if (nd) {
      const snippet = nd[1].slice(0, 3000);
      logCtx("__NEXT_DATA__", snippet, "tasa");
      
      // Parse y mostrar estructura de trmiExchange
      try {
        const json = JSON.parse(nd[1]);
        const pp = json?.props?.pageProps;
        if (pp?.trmiExchange !== undefined) {
          log("", "");
          log("ğŸ¯ trmiExchange encontrado:", "ok");
          logCtx("trmiExchange completo", JSON.stringify(pp.trmiExchange, null, 2).slice(0, 3000), "tasa");
        }
        if (pp?.banksXRates !== undefined) {
          log("", "");
          log("ğŸ¦ banksXRates:", "info");
          logCtx("banksXRates", JSON.stringify(pp.banksXRates, null, 2).slice(0, 2000), "USD");
        }
        // Mostrar TODOS los nÃºmeros 200-800 con su path
        log("", "");
        log("ğŸ”¢ Todos los nÃºmeros 200-800 en pageProps:", "info");
        const found = [];
        function hunt(obj, path="", d=0) {
          if (d>10||!obj||typeof obj!=='object') return;
          for (const [k,v] of Object.entries(obj)) {
            const p = path?`${path}.${k}`:k;
            if (typeof v==='number') {
              const n = Math.round(v);
              if (n>=200&&n<=800) found.push(`${p} = ${n}`);
            } else if (typeof v==='object') hunt(v,p,d+1);
          }
        }
        if (pp) hunt(pp);
        if (found.length) {
          found.forEach(f => log(`   ${f}`, "warn"));
        } else {
          log("   âš ï¸ NINGUNO â€” los datos llegan por fetch del cliente", "err");
          log("   â†’ Necesitamos interceptar la llamada API interna", "err");
        }
      } catch(e) {
        log(`   Error parseando NEXT_DATA: ${e.message}`, "err");
      }
    } else {
      log("   No encontrado", "err");
    }

    // â”€â”€ 2. Mostrar contexto de cada nÃºmero candidato (200-800) en el HTML crudo
    log("", "");
    log("ğŸ” Contexto de cada nÃºmero 200-800 en el HTML completo:", "info");
    const WINDOW = 120; // chars antes y despuÃ©s
    const seen = new Set();
    const matches = [...html.matchAll(/\b(\d{3,4})\b/g)];
    let count = 0;
    for (const m of matches) {
      const n = parseInt(m[1]);
      if (n < 200 || n > 800) continue;
      const key = `${n}-${Math.floor(m.index/200)}`; // dedupe por zona
      if (seen.has(key)) continue;
      seen.add(key);
      const start = Math.max(0, m.index - WINDOW);
      const end = Math.min(html.length, m.index + m[0].length + WINDOW);
      const context = html.slice(start, end);
      logCtx(`NÂº ${n} @ pos ${m.index}`, context, m[1]);
      count++;
      if (count >= 25) { log("   [truncado a 25 coincidencias]", "warn"); break; }
    }
    if (count === 0) log("   No hay ningÃºn nÃºmero 200-800 en el HTML crudo", "err");

  } catch(e) {
    log(`âœ— Error: ${e.message}`, "err");
  }

  log("", "");
  log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "");
  running = false;
  document.getElementById("btnRun").disabled = false;
}

log("ğŸ‘‹ Listo. Pulsa â–¶ para ver exactamente de dÃ³nde vienen los nÃºmeros.", "info");
</script>
</body>
</html>


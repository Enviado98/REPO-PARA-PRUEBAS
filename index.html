<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Debug Tasas</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0d1117; color: #e6edf3; font-family: 'Courier New', monospace; padding: 12px; font-size: 12px; }
  h1 { font-size: 14px; color: #58a6ff; margin-bottom: 4px; }
  p.sub { font-size: 11px; color: #8b949e; margin-bottom: 12px; }

  .rates-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px;
  }
  .rate-card {
    background: #161b22; border: 1px solid #30363d; border-radius: 6px;
    padding: 6px 8px; text-align: center;
  }
  .rate-card .label { font-size: 10px; color: #8b949e; }
  .rate-card .value { font-size: 15px; font-weight: bold; color: #3fb950; margin-top: 2px; }
  .rate-card .source { font-size: 9px; color: #58a6ff; margin-top: 1px; }

  .supabase-section {
    background: #161b22; border: 1px solid #30363d; border-radius: 6px;
    padding: 8px; margin-bottom: 10px;
  }
  .supabase-section h3 { font-size: 11px; color: #d29922; margin-bottom: 6px; }
  .sup-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 4px; }
  .sup-item { font-size: 11px; }
  .sup-item span { color: #8b949e; }

  #log-box {
    background: #161b22; border: 1px solid #30363d; border-radius: 6px;
    padding: 8px; height: 42vh; overflow-y: auto; margin-bottom: 10px;
  }
  .log-line { padding: 2px 0; border-bottom: 1px solid #1c2128; line-height: 1.5; }
  .log-line.warn { color: #d29922; }
  .log-line.error { color: #f85149; }
  .log-line.ok { color: #3fb950; }
  .log-line.info { color: #58a6ff; }
  .log-line.dim { color: #8b949e; }

  .btn-row { display: flex; gap: 8px; margin-bottom: 10px; }
  button {
    flex: 1; padding: 10px; border: none; border-radius: 6px;
    font-size: 13px; cursor: pointer; font-weight: bold;
  }
  .btn-run { background: #238636; color: #fff; }
  .btn-copy { background: #1f6feb; color: #fff; }
  .btn-supabase { background: #6e40c9; color: #fff; }
  button:active { opacity: 0.8; }
  .spinner { display: inline-block; animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<h1>ğŸ” Debug Tasas â€” Consulado Habana</h1>
<p class="sub">Replica exactamente la lÃ³gica de script.js Â· umbral >= 30</p>

<div class="rates-grid" id="rates-grid">
  <div class="rate-card"><div class="label">USD</div><div class="value" id="r-USD">---</div><div class="source" id="s-USD"></div></div>
  <div class="rate-card"><div class="label">EUR</div><div class="value" id="r-EUR">---</div><div class="source" id="s-EUR"></div></div>
  <div class="rate-card"><div class="label">MLC</div><div class="value" id="r-MLC">---</div><div class="source" id="s-MLC"></div></div>
  <div class="rate-card"><div class="label">CAD</div><div class="value" id="r-CAD">---</div><div class="source" id="s-CAD"></div></div>
  <div class="rate-card"><div class="label">MXN</div><div class="value" id="r-MXN">---</div><div class="source" id="s-MXN"></div></div>
  <div class="rate-card"><div class="label">BRL</div><div class="value" id="r-BRL">---</div><div class="source" id="s-BRL"></div></div>
  <div class="rate-card"><div class="label" style="color:#f0c040">ğŸ’ CLA</div><div class="value" id="r-CLA" style="color:#f0c040">---</div><div class="source" id="s-CLA"></div></div>
</div>

<div class="supabase-section" id="supabase-section" style="display:none">
  <h3>ğŸ“¦ Supabase (lo que tu web muestra ahora)</h3>
  <div class="sup-grid" id="sup-grid"></div>
  <div style="font-size:10px;color:#8b949e;margin-top:6px" id="sup-time"></div>
</div>

<div class="btn-row">
  <button class="btn-run" onclick="runDebug()" id="btn-run">â–¶ Ejecutar</button>
  <button class="btn-supabase" onclick="loadSupabase()">ğŸ“¦ Ver Supabase</button>
  <button class="btn-copy" onclick="copyLog()">ğŸ“‹ Copiar log</button>
</div>

<div id="log-box"></div>

<script type="module">
// â”€â”€ ConfiguraciÃ³n exacta de script.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL     = "https://mkvpjsvqjqeuniabjjwr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1rdnBqc3ZxanFldW5pYWJqandyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTI0MzU0OCwiZXhwIjoyMDgwODE5NTQ4fQ.No4ZOo0sawF6KYJnIrSD2CVQd1lHzNlLSplQgfuHBcg";
const CACHE_DURATION   = 10 * 60 * 1000;

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const DIVISAS = [
  { key: 'USD', stat: 'USD', col: 'dollar_cup', dec: 0, min: 200, max: 700 },
  { key: 'EUR', stat: 'ECU', col: 'euro_cup',   dec: 0, min: 200, max: 800 },
  { key: 'MLC', stat: 'MLC', col: 'mlc_cup',    dec: 0, min: 150, max: 700 },
  { key: 'CAD', stat: 'CAD', col: 'cad_cup',    dec: 0, min: 100, max: 600 },
  { key: 'MXN', stat: 'MXN', col: 'mxn_cup',    dec: 0, min: 5,   max: 100 },
  { key: 'BRL', stat: 'BRL', col: 'brl_cup',    dec: 0, min: 20,  max: 200 },
  { key: 'CLA', stat: 'CLA', col: 'cla_cup',    dec: 0, min: 200, max: 800 },
];

// â”€â”€ Logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const logLines = [];
function log(msg, type = 'dim') {
  const ts = new Date().toLocaleTimeString('es-ES');
  const entry = `[${ts}] ${msg}`;
  logLines.push(entry);
  const box = document.getElementById('log-box');
  const div = document.createElement('div');
  div.className = `log-line ${type}`;
  div.textContent = entry;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

window.copyLog = function() {
  navigator.clipboard.writeText(logLines.join('\n')).then(() => alert('âœ… Log copiado (' + logLines.length + ' lÃ­neas)'));
};

// â”€â”€ LÃ³gica exacta de script.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function elToqueVal(s, dec = 0) {
  if (!s) return null;
  const count = s.count_values ?? 0;
  let v, method;
  if (count >= 30 && s.median != null) {
    v = s.median; method = 'median';
  } else if (s.ema_value != null) {
    v = s.ema_value; method = 'ema_value';
  } else {
    v = s.median; method = 'median(fallback)';
  }
  if (v == null) return { val: null, method, count };
  const val = dec === 0 ? String(Math.round(v)) : String(+(v.toFixed(dec)));
  return { val, method, count, median: s.median, ema: s.ema_value };
}

function isValidRate(divisa, value) {
  const n = parseFloat(value);
  if (isNaN(n)) return false;
  const d = DIVISAS.find(d => d.key === divisa);
  return n >= (d?.min ?? 0) && n <= (d?.max ?? 99999);
}

async function fetchViaProxy(targetUrl, timeoutMs = 12000) {
  const proxies = [
    `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`,
    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`,
  ];
  for (const url of proxies) {
    const shortUrl = url.slice(0, 50) + '...';
    try {
      log(`  â³ Probando proxy: ${shortUrl}`, 'dim');
      const res = await Promise.race([
        fetch(url),
        new Promise((_, rej) => setTimeout(() => rej(new Error('Timeout')), timeoutMs))
      ]);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      if (text.length < 500) throw new Error('Respuesta muy corta');
      log(`  âœ… Proxy OK â€” ${text.length.toLocaleString()} chars`, 'ok');
      return text;
    } catch (e) {
      log(`  âŒ Proxy fallÃ³: ${e.message}`, 'error');
    }
  }
  throw new Error('Todos los proxies fallaron');
}

function extractStats(html, source) {
  const match = html.match(/<script id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);
  if (!match) throw new Error('__NEXT_DATA__ no encontrado');
  const json = JSON.parse(match[1]);
  const stats =
    json?.props?.pageProps?.trmiExchange?.data?.api?.statistics ||
    json?.props?.pageProps?.statistics ||
    json?.props?.pageProps?.data?.api?.statistics;
  if (!stats) throw new Error(`statistics no encontrado en ${source}`);
  return stats;
}

// â”€â”€ MAIN DEBUG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.runDebug = async function() {
  const btn = document.getElementById('btn-run');
  btn.innerHTML = '<span class="spinner">âŸ³</span> Ejecutando...';
  btn.disabled = true;
  document.getElementById('log-box').innerHTML = '';
  logLines.length = 0;

  log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
  log('ğŸš€ Iniciando debug â€” ' + new Date().toLocaleString('es-ES'), 'info');
  log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');

  // PASO 1: Leer Supabase
  log('', 'dim');
  log('PASO 1: Leer Supabase (valor actual guardado)', 'info');
  let currentStatus = {};
  try {
    const { data, error } = await supabase.from('status_data').select('*').eq('id', 1).single();
    if (error) throw new Error(error.message);
    currentStatus = data;
    log(`  âœ… Supabase OK`, 'ok');
    log(`  divisa_edited_at: ${data.divisa_edited_at || 'null'}`, 'dim');
    const age = data.divisa_edited_at ? Math.round((Date.now() - new Date(data.divisa_edited_at).getTime()) / 1000 / 60) : 999;
    log(`  Edad del cachÃ©: ${age} minutos`, age < 10 ? 'warn' : 'ok');
    for (const d of DIVISAS) {
      log(`  ${d.key}: ${data[d.col] || '---'} (Supabase)`, 'dim');
      document.getElementById('r-' + d.key).textContent = data[d.col] || '---';
      document.getElementById('s-' + d.key).textContent = 'supabase';
    }

    // PASO 2: Â¿Entra en cachÃ©?
    log('', 'dim');
    log('PASO 2: Verificar cachÃ© (CACHE_DURATION = 10 min)', 'info');
    const lastUpdate = new Date(data.divisa_edited_at || 0).getTime();
    const diff = Date.now() - lastUpdate;
    if (diff < CACHE_DURATION) {
      log(`  âš ï¸ CACHÃ‰ ACTIVO â€” faltan ${Math.round((CACHE_DURATION - diff) / 1000 / 60)} min para actualizar`, 'warn');
      log(`  â†’ La web NO consultarÃ¡ El Toque hasta que expire`, 'warn');
      log(`  â†’ MostrarÃ¡ los valores de Supabase de arriba`, 'warn');
      btn.innerHTML = 'â–¶ Ejecutar'; btn.disabled = false;
      return;
    } else {
      log(`  âœ… CachÃ© expirado â€” se consultarÃ¡ El Toque`, 'ok');
    }
  } catch (e) {
    log(`  âŒ Error Supabase: ${e.message}`, 'error');
  }

  // PASO 3: Fetch El Toque /es
  log('', 'dim');
  log('PASO 3: Fetch El Toque /es', 'info');
  let rawRates = {};
  let fetchSource = '';
  try {
    const html = await fetchViaProxy('https://eltoque.com/es');
    const stats = extractStats(html, '/es');
    log(`  âœ… statistics OK â€” procesando divisas...`, 'ok');
    fetchSource = 'El Toque /es';
    for (const d of DIVISAS) {
      const r = elToqueVal(stats[d.stat], d.dec);
      if (r && r.val) {
        rawRates[d.key] = r.val;
        const isCLA = d.key === 'CLA';
        log(`  ${isCLA ? 'ğŸ’' : '  '} ${d.key}: ${r.val} CUP (mÃ©todo: ${r.method}, count: ${r.count}, median: ${r.median}, ema: ${r.ema})`, isCLA ? 'warn' : 'dim');
      } else {
        log(`  ${d.key}: null â€” sin datos`, 'error');
      }
    }
  } catch (e1) {
    log(`  âŒ El Toque /es fallÃ³: ${e1.message}`, 'error');

    // PASO 3b: Fallback /tasas-de-cambio-cuba
    log('', 'dim');
    log('PASO 3b: Fallback â†’ /tasas-de-cambio-cuba', 'info');
    try {
      const html = await fetchViaProxy('https://eltoque.com/tasas-de-cambio-cuba');
      const stats = extractStats(html, '/tasas-de-cambio-cuba');
      fetchSource = 'El Toque HTML';
      for (const d of DIVISAS) {
        const r = elToqueVal(stats[d.stat], d.dec);
        if (r && r.val) {
          rawRates[d.key] = r.val;
          log(`  ${d.key}: ${r.val} (mÃ©todo: ${r.method}, count: ${r.count})`, 'dim');
        }
      }
    } catch (e2) {
      log(`  âŒ Fallback tambiÃ©n fallÃ³: ${e2.message}`, 'error');
    }
  }

  // PASO 4: Validar y mostrar resultado final
  log('', 'dim');
  log('PASO 4: ValidaciÃ³n y resultado final', 'info');

  if (!isValidRate('USD', rawRates.USD)) {
    log(`  âŒ USD invÃ¡lido (${rawRates.USD}) â€” ABORTANDO, no se actualizarÃ¡ Supabase`, 'error');
    btn.innerHTML = 'â–¶ Ejecutar'; btn.disabled = false;
    return;
  }

  log(`  âœ… USD vÃ¡lido (${rawRates.USD}) â€” continuando`, 'ok');
  log('', 'dim');

  for (const d of DIVISAS) {
    const fresh = rawRates[d.key];
    const prev = currentStatus[d.col] || null;
    const valid = isValidRate(d.key, fresh);
    const final = valid ? fresh : (prev || '---');
    const isCLA = d.key === 'CLA';
    if (valid) {
      log(`  ${isCLA?'ğŸ’':'  '} ${d.key}: ${fresh} âœ… vÃ¡lido â†’ se guarda en Supabase`, isCLA ? 'warn' : 'ok');
    } else {
      log(`  ${d.key}: ${fresh} âŒ invÃ¡lido â†’ conserva valor anterior (${prev})`, 'error');
    }
    document.getElementById('r-' + d.key).textContent = final;
    document.getElementById('s-' + d.key).textContent = valid ? fetchSource : 'supabase (prev)';
  }

  log('', 'dim');
  log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
  log('âœ… Debug completado', 'ok');
  log('  âš ï¸ NOTA: Este debug NO guarda en Supabase (solo lectura)', 'warn');

  btn.innerHTML = 'â–¶ Ejecutar'; btn.disabled = false;
};

// â”€â”€ Ver Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loadSupabase = async function() {
  try {
    const { data } = await supabase.from('status_data').select('*').eq('id', 1).single();
    const sec = document.getElementById('supabase-section');
    const grid = document.getElementById('sup-grid');
    sec.style.display = 'block';
    grid.innerHTML = DIVISAS.map(d => `
      <div class="sup-item"><span>${d.key}:</span> <b>${data[d.col] || '---'}</b></div>
    `).join('');
    document.getElementById('sup-time').textContent =
      'Ãšltima actualizaciÃ³n: ' + (data.divisa_edited_at ? new Date(data.divisa_edited_at).toLocaleString('es-ES') : 'nunca');
  } catch(e) {
    alert('Error Supabase: ' + e.message);
  }
};
</script>
</body>
</html>


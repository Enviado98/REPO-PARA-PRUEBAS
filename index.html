<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”¬ Cubadebate â€” DÃ©ficit Test</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@800&display=swap');
  :root { --bg:#0a0a0f; --s:#12121a; --b:#1e1e2e; --a:#00ffb3; --w:#ffb300; --e:#ff4d6d; --t:#e0e0f0; --m:#555577; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { background:var(--bg); color:var(--t); font-family:'JetBrains Mono',monospace; padding:1.5rem; }
  h1 { font-family:'Syne',sans-serif; font-size:1.4rem; color:var(--a); margin-bottom:.2rem; }
  .sub { color:var(--m); font-size:.72rem; margin-bottom:1.5rem; }

  .result-card { background:var(--s); border:1px solid var(--b); border-radius:12px; padding:1.5rem; text-align:center; margin-bottom:1.5rem; transition:border-color .3s; }
  .result-card.ok { border-color:var(--a); }
  .result-card.err { border-color:var(--e); }
  .rc-label { font-size:.65rem; color:var(--m); text-transform:uppercase; letter-spacing:.1em; margin-bottom:.5rem; }
  .rc-value { font-family:'Syne',sans-serif; font-size:3rem; font-weight:800; color:var(--a); line-height:1; }
  .rc-value.pending { color:var(--m); font-size:1.5rem; }
  .rc-value.fail { color:var(--e); font-size:1.2rem; }
  .rc-source { font-size:.6rem; color:var(--m); margin-top:.5rem; }

  .log { background:#080810; border:1px solid var(--b); border-radius:8px; padding:.8rem; height:380px; overflow-y:auto; font-size:.68rem; line-height:1.9; margin-bottom:1rem; }
  .ll { display:flex; gap:.5rem; }
  .lt { color:var(--m); min-width:5rem; }
  .lm { flex:1; word-break:break-all; }
  .lok .lm { color:var(--a); } .lwarn .lm { color:var(--w); } .lerr .lm { color:var(--e); } .linfo .lm { color:#7788ff; }

  .titles-box { background:#080810; border:1px solid var(--b); border-radius:8px; padding:.8rem; margin-bottom:1rem; display:none; }
  .titles-box h3 { font-size:.7rem; color:var(--m); text-transform:uppercase; letter-spacing:.1em; margin-bottom:.6rem; }
  .title-item { padding:.4rem .6rem; border-left:3px solid var(--b); margin-bottom:.4rem; font-size:.65rem; line-height:1.5; }
  .title-item.match { border-color:var(--a); color:var(--a); }
  .title-item.nomatch { border-color:var(--b); color:var(--m); }

  .btns { display:flex; gap:.6rem; flex-wrap:wrap; margin-bottom:.8rem; }
  button { background:var(--s); border:1px solid var(--b); color:var(--t); font-family:'JetBrains Mono',monospace; font-size:.72rem; padding:.5rem 1rem; border-radius:7px; cursor:pointer; transition:all .2s; }
  button:hover { border-color:var(--a); color:var(--a); }
  button.p { background:var(--a); border-color:var(--a); color:#000; font-weight:700; }
  button:disabled { opacity:.4; cursor:not-allowed; }
</style>
</head>
<body>

<h1>âš¡ Cubadebate â€” DÃ©ficit EnergÃ©tico</h1>
<p class="sub">ExtracciÃ³n desde RSS Â· cubadebate.cu/feed/</p>

<div class="result-card" id="resultCard">
  <div class="rc-label">ğŸ”Œ DÃ©ficit pronosticado</div>
  <div class="rc-value pending" id="resultValue">Â·Â·Â·</div>
  <div class="rc-source" id="resultSource">Esperando...</div>
</div>

<div class="btns">
  <button class="p" id="btnRun" onclick="runTest()">â–¶ Extraer dÃ©ficit</button>
  <button onclick="clearLog()">ğŸ—‘ Limpiar</button>
  <button onclick="toggleTitles()">ğŸ“° Ver todos los tÃ­tulos RSS</button>
</div>

<div class="log" id="logBox"></div>
<div class="titles-box" id="titlesBox">
  <h3>ğŸ“° Todos los tÃ­tulos del RSS (primeros 20)</h3>
  <div id="titlesList"></div>
</div>

<script>
const PROXIES = [
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
];

const RSS_URL = "http://www.cubadebate.cu/feed/";

// Patrones de tÃ­tulo que publica la UNE en Cubadebate
const UNE_KEYWORDS = ["dÃ©ficit", "deficit", "afectaciÃ³n", "afectacion", "uniÃ³n elÃ©ctrica", "union electrica", "une ", "pronÃ³stico", "pronostico"];

let allTitles = [];
let running = false;

function log(msg, type="") {
  const box = document.getElementById("logBox");
  const t = new Date().toLocaleTimeString("es",{hour12:false});
  const d = document.createElement("div");
  d.className = `ll l${type}`;
  d.innerHTML = `<span class="lt">[${t}]</span><span class="lm">${esc(msg)}</span>`;
  box.appendChild(d); box.scrollTop = box.scrollHeight;
}
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function clearLog() { document.getElementById("logBox").innerHTML = ""; allTitles = []; document.getElementById("titlesBox").style.display="none"; }

function toggleTitles() {
  const box = document.getElementById("titlesBox");
  if (!allTitles.length) { log("Sin tÃ­tulos aÃºn, ejecuta primero.", "warn"); return; }
  box.style.display = box.style.display === "block" ? "none" : "block";
}

function setResult(value, source, state) {
  const card = document.getElementById("resultCard");
  const val = document.getElementById("resultValue");
  const src = document.getElementById("resultSource");
  val.textContent = value;
  src.textContent = source;
  val.className = "rc-value " + state;
  card.className = "result-card " + (state === "" ? "ok" : state === "fail" ? "err" : "");
}

// Extraer nÃºmero de MW de un tÃ­tulo
function extractMW(title) {
  const t = title.toLowerCase();
  // Patrones: "1 680 MW", "1680 MW", "1.680 MW"
  const patterns = [
    /(\d[\d\s\.]{1,6}\d)\s*mw/i,
    /(\d{3,4})\s*megawatt/i,
  ];
  for (const pat of patterns) {
    const m = t.match(pat);
    if (m) {
      const n = parseInt(m[1].replace(/[\s\.]/g, ""));
      if (n >= 100 && n <= 5000) return n;
    }
  }
  return null;
}

// Â¿Este tÃ­tulo es de la UNE sobre dÃ©ficit?
function isUNETitle(title) {
  const t = title.toLowerCase();
  return UNE_KEYWORDS.some(k => t.includes(k));
}

async function runTest() {
  if (running) return;
  running = true;
  document.getElementById("btnRun").disabled = true;
  setResult("Â·Â·Â·", "Buscando...", "pending");
  allTitles = [];

  log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "");
  log(`ğŸš€ Fetching RSS: ${RSS_URL}`, "info");

  let xml = null;

  // Intentar proxies en orden
  for (let i = 0; i < PROXIES.length; i++) {
    const proxyUrl = PROXIES[i](RSS_URL);
    log(`ğŸ“¡ Proxy ${i+1}: ${proxyUrl.slice(0, 60)}...`, "");
    try {
      const res = await Promise.race([
        fetch(proxyUrl),
        new Promise((_,rej) => setTimeout(() => rej(new Error("Timeout 12s")), 12000))
      ]);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      if (text.length < 500) throw new Error(`Respuesta muy corta (${text.length} chars)`);
      xml = text;
      log(`âœ… Proxy ${i+1} OK â€” ${text.length.toLocaleString()} chars`, "ok");
      break;
    } catch(e) {
      log(`âœ— Proxy ${i+1}: ${e.message}`, "err");
    }
  }

  if (!xml) {
    setResult("Error", "Todos los proxies fallaron", "fail");
    log("âŒ No se pudo obtener el RSS.", "err");
    running = false; document.getElementById("btnRun").disabled = false;
    return;
  }

  // Parsear tÃ­tulos del XML
  log("", "");
  log("ğŸ” Analizando tÃ­tulos del RSS...", "info");

  // Extraer todos los <title> (saltando el primero que es el del sitio)
  const rawTitles = [...xml.matchAll(/<title>(?:<!\[CDATA\[)?([\s\S]*?)(?:\]\]>)?<\/title>/gi)]
    .map(m => m[1].trim())
    .filter(t => t.length > 5)
    .slice(1, 25); // saltar el primero (nombre del sitio), tomar hasta 25

  log(`ğŸ“° ${rawTitles.length} tÃ­tulos encontrados`, "");
  allTitles = rawTitles;

  // Render en el panel de tÃ­tulos
  const listEl = document.getElementById("titlesList");
  listEl.innerHTML = rawTitles.map(t => {
    const isUne = isUNETitle(t);
    const mw = extractMW(t);
    return `<div class="title-item ${isUne ? 'match' : 'nomatch'}">
      ${isUne ? 'âš¡' : 'Â·'} ${esc(t)} ${mw ? `<strong>[${mw} MW]</strong>` : ''}
    </div>`;
  }).join("");

  // Buscar el primer tÃ­tulo que coincida y tenga nÃºmero
  let found = null;
  let foundTitle = "";

  for (const title of rawTitles) {
    if (!isUNETitle(title)) continue;
    const mw = extractMW(title);
    if (mw) {
      found = mw;
      foundTitle = title;
      log(`âœ… MATCH: "${title}"`, "ok");
      log(`   â†’ ${mw} MW`, "ok");
      break;
    } else {
      log(`âš ï¸ TÃ­tulo UNE sin nÃºmero MW: "${title}"`, "warn");
    }
  }

  log("", "");

  if (found) {
    setResult(`${found} MW`, `Fuente: "${foundTitle.slice(0, 60)}..."`, "");
    log(`ğŸ‰ RESULTADO: ${found} MW de dÃ©ficit`, "ok");
    log(`ğŸ“° TÃ­tulo: "${foundTitle}"`, "ok");
    log("", "");
    log("âœ… El mÃ©todo funciona. Este es el cÃ³digo para script.js:", "ok");
    log(`   stats = json.trmiExchange... â† tasas`, "");
    log(`   deficitMW = extractMW(rssTitle) â† dÃ©ficit`, "");
  } else {
    setResult("N/D", "No encontrado en RSS de hoy", "fail");
    log("âš ï¸ No se encontrÃ³ artÃ­culo de dÃ©ficit en el RSS actual.", "warn");
    log("   Posibles causas:", "warn");
    log("   1. La UNE no publicÃ³ hoy aÃºn (se publica por la maÃ±ana)", "warn");
    log("   2. El tÃ­tulo usa palabras distintas a las esperadas", "warn");
    log("   3. Abre 'ğŸ“° Ver todos los tÃ­tulos RSS' para inspeccionar", "warn");
  }

  log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", "");
  running = false;
  document.getElementById("btnRun").disabled = false;
}

log("ğŸ‘‹ Listo. Pulsa â–¶ para extraer el dÃ©ficit desde Cubadebate.", "info");
log("ğŸ“¡ Fuente: cubadebate.cu/feed/ (RSS pÃºblico, sin autenticaciÃ³n)", "");
</script>
</body>
</html>

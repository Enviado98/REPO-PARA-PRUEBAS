<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ğŸ” Test El Toque â€“ Todas las Divisas</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: monospace; background: #0d1117; color: #c9d1d9; padding: 20px; }
  h1 { color: #58a6ff; margin-bottom: 6px; }
  p  { color: #8b949e; margin-bottom: 16px; font-size: 13px; }
  .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin: 12px 0; }
  .ok   { color: #3fb950; }
  .err  { color: #f85149; }
  .warn { color: #d29922; }
  .dim  { color: #8b949e; }
  table { border-collapse: collapse; width: 100%; }
  td, th { border: 1px solid #30363d; padding: 8px 12px; text-align: left; font-size: 13px; }
  th { color: #58a6ff; background: #0d1117; }
  tr:hover td { background: #1f2937; }
  .val { font-weight: bold; font-size: 15px; color: #3fb950; }
  pre  { overflow-x: auto; background: #0d1117; padding: 12px; border-radius: 6px;
         font-size: 11px; max-height: 400px; overflow-y: auto; }
  button { background: #238636; color: white; border: none; padding: 10px 20px;
           border-radius: 6px; cursor: pointer; font-size: 14px; margin: 4px; }
  button:hover { background: #2ea043; }
  button.sec { background: #21262d; }
  button.sec:hover { background: #30363d; }
  #timestamp { color: #58a6ff; font-size: 12px; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px;
           font-size: 11px; background: #21262d; color: #8b949e; }
  .badge.new { background: #1f3a1f; color: #3fb950; }
  .section-title { color: #8b949e; font-size: 11px; text-transform: uppercase;
                   letter-spacing: 1px; margin: 16px 0 6px; }
</style>
</head>
<body>
<h1>ğŸ” El Toque â€“ Test completo de divisas</h1>
<p>Extrae USD, EUR, MLC, CAD, MXN, BRL, CLA y cualquier otra moneda disponible en el JSON.</p>

<button onclick="runTest()">â–¶ Ejecutar test</button>
<button class="sec" onclick="toggleRaw()">ğŸ“¦ Ver JSON crudo</button>
<button class="sec" onclick="clearLog()">ğŸ—‘ Limpiar</button>
<span id="timestamp"></span>

<div class="card" id="resultado"><em class="dim">Haz clic en "Ejecutar test"â€¦</em></div>

<div class="card" id="all-keys-card" style="display:none">
  <div class="section-title">ğŸ— Todas las claves disponibles en statistics</div>
  <div id="all-keys"></div>
</div>

<div class="card" id="raw-card" style="display:none">
  <div class="section-title">ğŸ“¦ JSON crudo â€“ monedas objetivo</div>
  <pre id="raw-json"></pre>
</div>

<div class="card">
  <div class="section-title">ğŸ“‹ Log</div>
  <pre id="log"></pre>
</div>

<script>
// â”€â”€â”€ ConfiguraciÃ³n de monedas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// key    = clave en el JSON de El Toque (statistics.KEY.median)
// label  = texto a mostrar
// icon   = emoji de bandera
// isNew  = true = reciÃ©n agregada (destacar)
const CURRENCIES = [
  { key: 'USD', label: 'DÃ³lar USD',        icon: 'ğŸ‡ºğŸ‡¸', isNew: false },
  { key: 'ECU', label: 'Euro EUR',          icon: 'ğŸ‡ªğŸ‡º', isNew: false },
  { key: 'MLC', label: 'MLC',              icon: 'ğŸ’³',  isNew: false },
  { key: 'CAD', label: 'DÃ³lar Canadiense', icon: 'ğŸ‡¨ğŸ‡¦', isNew: true  },
  { key: 'MXN', label: 'Peso Mexicano',    icon: 'ğŸ‡²ğŸ‡½', isNew: true  },
  { key: 'BRL', label: 'Real BrasileÃ±o',   icon: 'ğŸ‡§ğŸ‡·', isNew: true  },
  { key: 'CLA', label: 'ClÃ¡sica CLA',      icon: 'ğŸ’',  isNew: true  },
];

// â”€â”€â”€ Proxies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROXIES = [
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
];
const TARGET = 'https://eltoque.com/tasas-de-cambio-cuba';

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, cls = '') {
  const pre = document.getElementById('log');
  const ts  = new Date().toLocaleTimeString('es-ES');
  pre.innerHTML += `<span class="${cls}">[${ts}] ${msg}</span>\n`;
  pre.scrollTop  = pre.scrollHeight;
}

function clearLog() {
  document.getElementById('log').innerHTML      = '';
  document.getElementById('resultado').innerHTML = '<em class="dim">Log limpiado.</em>';
  document.getElementById('all-keys-card').style.display = 'none';
  document.getElementById('raw-card').style.display      = 'none';
}

function toggleRaw() {
  const c = document.getElementById('raw-card');
  c.style.display = c.style.display === 'none' ? 'block' : 'none';
}

function fmt(val, decimals = 2) {
  return val != null ? Number(val).toFixed(decimals) : '<span class="dim">N/A</span>';
}

// â”€â”€â”€ Fetch via proxy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchViaProxy(proxyFn) {
  const url = proxyFn(TARGET);
  log(`â³ Proxy: ${url.slice(0, 55)}â€¦`);
  const res = await fetch(url, { signal: AbortSignal.timeout(13000) });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.text();
}

// â”€â”€â”€ Extrae statistics del __NEXT_DATA__ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractStats(html) {
  const match = html.match(/<script id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);
  if (!match) throw new Error('__NEXT_DATA__ no encontrado');
  const json  = JSON.parse(match[1]);
  const stats = json?.props?.pageProps?.trmiExchange?.data?.api?.statistics;
  if (!stats)  throw new Error('trmiExchange.data.api.statistics no encontrado');
  return stats;
}

// â”€â”€â”€ Test principal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runTest() {
  document.getElementById('resultado').innerHTML        = '<em class="dim">â³ Consultando El Toqueâ€¦</em>';
  document.getElementById('all-keys-card').style.display = 'none';
  document.getElementById('raw-card').style.display      = 'none';
  document.getElementById('timestamp').textContent       = '';
  log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  log('ğŸš€ Iniciando test â€“ ' + new Date().toLocaleString('es-ES'));

  // Intentar proxies
  let html = null, proxyUsed = '?';
  for (let i = 0; i < PROXIES.length; i++) {
    try {
      html      = await fetchViaProxy(PROXIES[i]);
      proxyUsed = i === 0 ? 'allorigins.win' : 'codetabs.com';
      log(`âœ… Proxy ${i+1} OK â€” ${html.length.toLocaleString()} chars`, 'ok');
      break;
    } catch (e) {
      log(`âŒ Proxy ${i+1} fallÃ³: ${e.message}`, 'err');
    }
  }

  if (!html) {
    log('ğŸ’€ Todos los proxies fallaron.', 'err');
    document.getElementById('resultado').innerHTML =
      '<span class="err">âŒ No se pudo obtener datos. Intenta de nuevo.</span>';
    return;
  }

  // Extraer stats
  let stats;
  try {
    stats = extractStats(html);
    log(`âœ… statistics extraÃ­do â€” ${Object.keys(stats).length} monedas encontradas`, 'ok');
  } catch (e) {
    log(`âŒ Error parseando: ${e.message}`, 'err');
    document.getElementById('resultado').innerHTML = `<span class="err">âŒ ${e.message}</span>`;
    return;
  }

  // Mostrar todas las claves disponibles
  const allKeys = Object.keys(stats).sort();
  log(`ğŸ— Claves: ${allKeys.join(', ')}`);
  document.getElementById('all-keys').innerHTML = allKeys.map(k => {
    const median = stats[k]?.median;
    const found  = CURRENCIES.find(c => c.key === k);
    const cls    = found ? 'badge new' : 'badge';
    return `<span class="${cls}" title="${k}: median=${median ?? 'N/A'}">${k}${median != null ? ' âœ“' : ''}</span> `;
  }).join('');
  document.getElementById('all-keys-card').style.display = 'block';

  // JSON crudo de monedas objetivo
  const targetKeys = CURRENCIES.reduce((acc, c) => { acc[c.key] = stats[c.key] ?? null; return acc; }, {});
  document.getElementById('raw-json').textContent = JSON.stringify(targetKeys, null, 2);

  // Construir tabla de resultados
  let rows = '';
  const results = {};

  for (const cur of CURRENCIES) {
    const s = stats[cur.key];
    if (!s) {
      log(`âš ï¸ ${cur.key}: clave no encontrada en statistics`, 'warn');
      rows += `
        <tr>
          <td>${cur.icon} ${cur.label}</td>
          <td><code>${cur.key}</code></td>
          <td colspan="4" class="err">âŒ No disponible en el JSON</td>
        </tr>`;
      continue;
    }

    const median  = s.median != null ? s.median : null;
    const avg     = s.avg    != null ? s.avg    : null;
    const diff    = (median != null && avg != null) ? (avg - median) : null;
    const diffCls = diff != null && Math.abs(diff) > 3 ? 'err' : 'ok';
    const rounded = median != null ? Math.round(median) : null;

    results[cur.key] = rounded;
    log(
      `${cur.icon} ${cur.key}: median=${fmt(median)} | avg=${fmt(avg)} | diff=${diff != null ? fmt(diff) : 'N/A'}`,
      diff != null && Math.abs(diff) > 3 ? 'warn' : 'ok'
    );

    const newBadge = cur.isNew ? ' <span class="badge new">NUEVO</span>' : '';

    rows += `
      <tr>
        <td>${cur.icon} ${cur.label}${newBadge}</td>
        <td><code>${cur.key}</code></td>
        <td class="val">${rounded != null ? rounded + ' CUP' : '<span class="err">N/A</span>'}</td>
        <td class="dim">${fmt(avg)}</td>
        <td class="ok">${fmt(median)}</td>
        <td class="${diffCls}">${diff != null ? (diff > 0 ? '+' : '') + fmt(diff) : 'N/A'}</td>
      </tr>`;
  }

  const now = new Date().toLocaleString('es-ES');
  document.getElementById('timestamp').textContent = `  Â·  ${now}  Â·  ${proxyUsed}`;

  document.getElementById('resultado').innerHTML = `
    <div class="section-title">âœ… Resultados â€” ${now} â€” proxy: ${proxyUsed}</div>
    <br>
    <table>
      <thead>
        <tr>
          <th>Moneda</th>
          <th>Clave JSON</th>
          <th>Valor (median redondeado) âœ…</th>
          <th>avg âš ï¸</th>
          <th>median exacto</th>
          <th>Diferencia avgâˆ’median</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    <br>
    <div class="section-title">ğŸ“‹ Snippet para tu script.js</div>
    <pre>${generateSnippet(results)}</pre>
  `;

  log('âœ… Test completado', 'ok');
}

function generateSnippet(results) {
  return `// Tasas extraÃ­das con .median (correcto)
return {
    usd: stats.USD?.median != null ? String(Math.round(stats.USD.median)) : null,
    eur: stats.ECU?.median != null ? String(Math.round(stats.ECU.median)) : null,
    mlc: stats.MLC?.median != null ? String(Math.round(stats.MLC.median)) : null,
    cad: stats.CAD?.median != null ? String(Math.round(stats.CAD.median)) : null,
    mxn: stats.MXN?.median != null ? String(Math.round(stats.MXN.median)) : null,
    brl: stats.BRL?.median != null ? String(Math.round(stats.BRL.median)) : null,
    cla: stats.CLA?.median != null ? String(Math.round(stats.CLA.median)) : null,
};

// Valores actuales detectados:
${Object.entries(results).map(([k,v]) => `// ${k}: ${v} CUP`).join('\n')}`;
}
</script>
</body>
</html>
